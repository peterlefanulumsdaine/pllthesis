
% \comment{Give: the globes, and variants of globes; the Kan constructions; fact that pasting diagrams get realised by these; resulting functors $\DTT \to \Alg{\End(\globes)}$.]}

In this chapter we will construct classifying weak $\omega$-categories for theories with various extensionality rules, and discuss how it might be possible to extend this to require only the $\Id$-types; we also give a variant which works for theories with just $\Id$- and $\Pi$-types.

The construction of the classifying weak $\omega$-category is closely analogous to that of the fundamental weak $\omega$-groupoid of a space: it is obtained by homming out of a complex of representing objects (``globes''), and so it is enough to show that these representing objects form a co-(weak $\omega$-category), just as the topological globes $D^0 \two D^1 \two D^2 \two \cdots\quad$ do in $\Top$.

To this end, in Section \ref{sec:glob-strux-from-dtt} we introduce our representing objects, the \emph{type-theoretic globes} $\globes$.  We then develop, in Section \ref{sec:homot-strux-on-dtt}, classes of left and right maps on $\DTT$ (\emph{term extensions} vs.\ \emph{term-contractible maps}), and isolate a property $\Jbar$ (in syntactic terms, a conservativity principle), ensuring that the maps $\T_\stuff[\widehat{\pi}] \to/{-|>}/ \T_\stuff[\widehat{\pi^-}]$ are term-contractible. (This thus fulfils a function dual to that of the elim-structure on $\Gamma_{\pi^-} \to/{|>->}/ \Gamma_{\pi}$ in the preceding section.)  Finally, in Section \ref{sec:contractibility}, we put the pieces together, with arguments extending those of \ref{thm:p-is-contractible} and its corollaries, to show that various operads are contractible, and deduce the desired weak $\omega$-category structures.

\section{Globular structures from \pdfDTT} \label{sec:glob-strux-from-dtt}

\subsection*{The type-theoretic globes}

\begin{para} Once again, let $\stuff$ be some set of rules/constructors, including at least the $\Id$-rules.  The \emph{type-theoretic globes} over $\stuff$ are then a sequence of theories $\globe[n]^\stuff$ which play a similar r\^o{}le in $\DTT_\stuff$ to that which the discs $D^n$ play in $\Top$: they are an internal weak-$\omega$-cocategory, and as such will---almost---be representing objects for the classifying weak $\omega$-category functor.
\end{para}

The idea is that $\globe[0]^\stuff$ should be the free theory on a singler closed type $\Cterm$; then $\globe[1]^\stuff$, the free theory on two types $\Sterm$, $\Tterm$ and a map $\cterm_1$ between them; $\globe[2]^\stuff$, free on two types $\Sterm$, $\Tterm$, two maps $\sterm_1$, $\tterm_1$  between them, and a term $\cterm_2$ of propositional identity between these; and so on.  Precisely:

\begin{definition} $\globe[n]^\stuff$ is the theory over $\stuff$ generated by axioms $i$-$\sourcerule$, $i$-$\targetrule$ (for $0 \leq i < n$), and $n$-$\cellrule$, as follows:
\[
\inferrule*[right={0-$\sourcerule$}]{\ }{\diamond \types \Sterm\ \type} \qquad 
\inferrule*[right={0-$\targetrule$}]{\ }{\diamond \types \Tterm\ \type} \qquad 
\inferrule*[right={0-$\cellrule$}]{\ }{\diamond \types \Cterm\ \type}
\]
\[ 
\inferrule*[right={1-$\sourcerule$}]{\ }{x:\Sterm \types \sterm_1(x): \Tterm} \qquad
\inferrule*[right={1-$\targetrule$}]{\ }{x:\Sterm \types \tterm_1(x): \Tterm} \qquad
\inferrule*[right={1-$\cellrule$}]{\ }{x:\Sterm \types \cterm_1(x): \Tterm} 
\]
\[
\inferrule*[right={$i$-$\sourcerule$}]{\ }{\Gamma \types \sterm_i(x):\Id(\sterm_{i-1}(x),\tterm_{i-1}(x))} \qquad (i \geq 2)
\]
and $i$-$\targetrule$ , $i$-$\cellrule$\ exactly as $i$-$\sourcerule${} except defining term-formers $\tterm_i$, $\cterm_i$ in place of $\sterm_i$. 
\vspace{-1ex}
\[
\begin{array}{ccc}
\quad  \xy
(0,0)*{\bullet};
(0,80)*{\Cterm};
(-200,200)*{}="tl"; % bounding box
(200,200)*{}="tr";
(-200,-150)*{}="bl";
(200,-150)*{}="br";
"tl";"tr" **\dir{.};
"tl";"bl" **\dir{.};
"tr";"br" **\dir{.};
"bl";"br" **\dir{.};
\endxy \quad 
&
\quad \xy
(0,0)*{\bullet}="S";
(0,80)*{\Sterm};
(400,0)*{\bullet}="T";
(400,80)*{\Tterm};
{\ar "S";"T"};
(200,80)*{\cterm_1};
(-150,200)*{}="tl"; % bounding box
(550,200)*{}="tr";
(-150,-150)*{}="bl";
(550,-150)*{}="br";
"tl";"tr" **\dir{.};
"tl";"bl" **\dir{.};
"tr";"br" **\dir{.};
"bl";"br" **\dir{.};
\endxy \quad 
&
\quad \xy
(0,0)*+{\bullet}="S";
(0,80)*{ \Sterm};
(450,0)*+{\bullet}="T";
(450,80)*{\Tterm};
{\ar@/^1pc/ "S";"T"};
{\ar@/_1pc/ "S";"T"};
{\ar@{=>} (210,85)*{};(210,-85)*{}};
(225,170)*{\sterm_1};
(225,-170)*{\tterm_1};
(295,0)*{\cterm_2};
(-150,280)*{}="tl"; % bounding box
(600,280)*{}="tr";
(-150,-280)*{}="bl";
(600,-280)*{}="br";
"tl";"tr" **\dir{.};
"tl";"bl" **\dir{.};
"tr";"br" **\dir{.};
"bl";"br" **\dir{.};
\endxy \quad \\
\globe[0] &
\globe[1] &
\globe[2]
\end{array}
\]
(Often, when working with some fixed $\stuff$, we write just $\globe[n]$ for $\globe[n]^\stuff$.)
\end{definition}

\begin{para} There are evident co-source and co-target interpretations  between these theories (sending for instance $\cterm_i$ to $\sterm_i$ or $\tterm_i$), and moreover co-unit interpretations (sending $\cterm_{i+1}$ to $r(\cterm_{i})$), forming a reflexive coglobular object $\globes$ in $\DTT_\stuff$:

\[ \globe[0]\, \three/->`<-`->/<500>\ \globe[1]\, \three/->`<-`->/<500>\ \globe[2]\, \three/->`<-`->/<500> \ \ldots \]

Leaving aside the reflexivity for now, we can thus see the globes as a functor
\[ \globes \colon \G \to \DTT_\stuff .\]
Since $\DTT_\stuff$ is co-complete, this induces by general nonsense (\cite[VII.2]{mac-lane-moerdijk}) an adjoint pair of functors between $\GSets$ and $\DTT_\stuff$ (a ``Kan situation'').  Both these functors will be of central interest to us in the sequel:
\[\quad \xymatrix{ \GSets \ar@/_/[rrr]_{\T_\stuff [-]\, :=\, \Lan_\yon \globes \qquad \ \, } \ar@{}[rrr]|\top & & & \DTT_\stuff \ar@/_/[lll]_{\cl^-_\omega\ :=\ \DTT_\stuff(\globes,-)} \\ \G \ar@{ >->}[u]^\yon \ar@/_/[urrr]_{\globes} }
\]

The right adjoint, $\cl^-_\omega \colon \DTT_\stuff\ \to\ \GSets$, is defined by homming out of the globes, i.e.\ by setting $\cl^-_\omega(\T)_n = \DTT_\stuff(\globe[n],\T)$.  Thus, by the definitions of the globes, the 0-cells of $\cl^-_\omega(\T)$ correspond exactly to closed types in $\T$; the 1-cells $A \to B$ to terms of $A$ dependent on a single variable from $B$; the 2-cells to terms of type $\Id_B$ between 1-cells; and so on.

This is very nearly, but not quite, what we wanted for the underlying globular set of $\cl_\omega(\T)$.  The difference is that it has only the \emph{types} of $\T$ as 0-cells, not all the contexts; however, we will proceed for now with $\cl^-_\omega$, and remedy this deficiency later.

Meanwhile, the left adjoint $\T_\stuff [-] \colon \GSets\ \to\ \DTT_\stuff$ is constructed as the left Kan extension of $\globes$ along $\yon$, and may be seen as freely adjoining a globular set to $\T_\stuff$, using the globes as templates.  Explicitly, for a globular set $\X$, the theory $\T[\X]$ has an axiom for each cell of $\X$, realising the 0-cells as closed types, the 1-cells as terms between these types, and the higher-cells as terms of appropriate identity types.\footnote{A related construction is considered in \cite{awodey-hofstra-warren} and \cite{hofstra-warren}, corresponding to a slightly different co-globular theory: they omit our $\globe[0]$, giving instead just a single closed base type, and realise $0$-cells as closed terms of this type, $1$-cells as terms of identity type between these, and so forth.  Their $T_\mathbf{ML}$ is then the monad induced by the Kan adjunction.}

In particular, $\T_\stuff[\yon(n)] = \globe[n]$, and the theories $\T_\stuff[\widehat{\pi}]$ give the diagram objects of $\globes$.  Also useful will be the boundary of the  $n$-globe, $\del \globe[n] := \T_\stuff[\del(n)]$; up to isomorphism, this is the theory given by $i$-$\sourcerule$ and $i$-$\targetrule$, for $0 \leq i < n$, i.e.\ all the axioms of $\globe[n]$ except for $n$-$\cellrule$ itself.
\end{para}
 
 
\begin{para} Since $\DTT_\stuff$ is co-complete, we can consider (by \ref{def:endo-operad}) the co-endomorphism operad of the globes, $\End_{\Spans[\DTT_\stuff^\op]}(\globes)$, or briefly just $\End(\globes)$.  We know that its operations of some shape $\pi$ are given by
\[\End(\globes)(\pi) \iso \Spans[\DTT_\stuff^\op]_n (\globe[n], \T_\stuff[\hat{\pi}])\]
and hence, unwinding this formula, consist of diagrams as in Fig.\ \ref{fig:endo-pylons} below.

\begin{figure}[htbp]
\[\bfig
%%%%%%%%%%%%%%%%%%%
% left hand pylon %
%%%%%%%%%%%%%%%%%%%
\node gn(250,0)[\globefig{n}]
\node gn1l(0,-250)[\globefig{n-1}]
\node gn1r(500,-400)[\globefig{n-1}]
\node gn2l(0,-650)[\globefig{n-2}]
\node fakegn2l(450,-650)[]
\node gn2r(500,-800)[\globefig{n-2}]
\node g1l(0,-1150)[\globefig{1}]
\node g1r(500,-1300)[\globefig{1}]
\node g0l(0,-1550)[\globefig{0}]
\node g0r(500,-1700)[\globefig{0}]
\arrow[gn1l`gn;]
\arrow[gn1r`gn;]
\arrow[gn2l`gn1l;]
\arrow[gn2r`gn1l;]
\arrow[gn2l`gn1r;]
\arrow[gn2r`gn1r;]
\arrow/@{}|<>(0.58)\vdots/[g1l`gn2l;]
\arrow/@{}|<>(0.58)\vdots/[g1r`gn2r;]
\arrow[g0l`g1l;]
\arrow[g0r`g1l;]
\arrow[g0l`g1r;]
\arrow[g0r`g1r;]
%%%%%%%%%%%%%%%%%%%%
% right hand pylon %
%%%%%%%%%%%%%%%%%%%%
\node Tpi(1750,0)[{\T_\stuff[\widehat{\pi}]}]
\node Tspi(1500,-250)[{\T_\stuff[\widehat{s\pi}]}]
\node Ttpi(2000,-400)[{\T_\stuff[\widehat{t\pi}]}]
\node Ts2pi(1500,-650)[{\T_\stuff[\widehat{s^2\pi}]}]
\node Tt2pi(2000,-800)[{\T_\stuff[\widehat{t^2\pi}]}]
\node Ts1pi(1500,-1150)[{\T_\stuff[\widehat{s_1\pi}]}]
\node Tt1pi(2000,-1300)[{\T_\stuff[\widehat{t_1\pi}]}]
\node Ts0pi(1500,-1550)[{\T_\stuff[\widehat{s_0\pi}]}]
\node Tt0pi(2000,-1700)[{\T_\stuff[\widehat{t_0\pi}]}]
\arrow[Tspi`Tpi;]
\arrow[Ttpi`Tpi;]
\arrow/@{>}|!{(500,-400);(2000,-400)}\hole/[Ts2pi`Tspi;]
\arrow/@{>}|!{(500,-400);(2000,-400)}\hole/[Tt2pi`Tspi;]
\arrow[Ts2pi`Ttpi;]
\arrow[Tt2pi`Ttpi;]
\arrow/@{}|<>(0.58)\vdots/[Ts1pi`Ts2pi;]
\arrow/@{}|<>(0.58)\vdots/[Tt1pi`Tt2pi;]
\arrow/@{>}|!{(500,-1300);(2000,-1300)}\hole/[Ts0pi`Ts1pi;]
\arrow/@{>}|!{(500,-1300);(2000,-1300)}\hole/[Tt0pi`Ts1pi;]
\arrow[Ts0pi`Tt1pi;]
\arrow[Tt0pi`Tt1pi;]
%%%%%%%%%%%%%%%%%%%%
% connecting wires %
%%%%%%%%%%%%%%%%%%%%
\arrow[gn`Tpi;H]
\arrow/@{>}|!{(250,0);(500,-400)}\hole/[gn1l`Tspi;F_{n-1}]
\arrow[gn1r`Ttpi;G_{n-1}]
\arrow/@{>}|<>(.19)\hole|!{(500,-800);(500,-400)}\hole/[gn2l`Ts2pi;F_{n-2}]
\arrow[gn2r`Tt2pi;G_{n-2}]
\arrow[g1l`Ts1pi;F_1]
\arrow[g1r`Tt1pi;G_1]
\arrow/@{>}|<>(.21)\hole|!{(500,-1700);(500,-1300)}\hole/[g0l`Ts0pi;F_0]
\arrow[g0r`Tt0pi;G_0]
\efig\]
\caption{An operation in an endomorphism operad\label{fig:endo-pylons}}
\end{figure}
\end{para}

\begin{para} \label{para:endo-op-example}
For example, a composition law for $\xymatrix{ \bullet \rtwocell & \bullet \rtwocell& \bullet}$ is given by the map of spans
\[
\xy
%
% left pylon:
%
(0,50)*+{\globe[2]}="g2";
(-350,-300)*+{\globe[1]}="g1l";
(350,-550)*+{\globe[1]}="g1r";
(-350,-900)*+{\globe[0]}="g0l";
(350,-1150)*+{\globe[0]}="g0r";
{\ar "g1l";"g2"};
{\ar "g1r";"g2"};
{\ar "g0l";"g1l"};
{\ar "g0r";"g1l"};
{\ar "g0l";"g1r"};
{\ar "g0r";"g1r"};
%
% right pylon:
%
(2100,50)*+{\T_\Phi\! \left[ 
  \xy 
  (0,0)*=<1.8ex,1.5ex>{\scriptstyle P}="P";
  (350,0)*=<1.8ex,1.5ex>{\scriptstyle Q}="Q";
  (700,0)*=<1.8ex,1.5ex>{\scriptstyle R}="R";
  {\ar@/^1pc/|{f} "P";"Q"};
  {\ar@/_1pc/|{f'} "P";"Q"};
  {\ar@{=>}^{\alpha} (155,65);(155,-70)};
  {\ar@/^1pc/|{g} "Q";"R"};
  {\ar@/_1pc/|{g'} "Q";"R"};
  {\ar@{=>}^{\beta} (505,65);(505,-70)};
  \endxy
\right] }="Tpi";
(1750,-300)*+{\T_\Phi \left[ 
  \xy 
  (0,0)*=<1.8ex,1.5ex>{\scriptstyle P}="P";
  (275,0)*=<1.8ex,1.5ex>{\scriptstyle Q}="Q";
  (550,0)*=<1.8ex,1.5ex>{\scriptstyle R}="R";
  {\ar|(0.48){f} "P";"Q"};
  {\ar|(0.48){g} "Q";"R"};
  \endxy
\right] }="Tspi";
(2450,-550)*+{\T_\Phi \left[ 
  \xy 
  (0,0)*=<1.8ex,1.5ex>{\scriptstyle P}="P";
  (275,0)*=<1.8ex,1.5ex>{\scriptstyle Q}="Q";
  (550,0)*=<1.8ex,1.5ex>{\scriptstyle R}="R";
  {\ar|(0.47){f'} "P";"Q"};
  {\ar|(0.47){g'} "Q";"R"};
  \endxy
\right] }="Ttpi";
(1750,-900)*+{\T_\Phi [ P ] }="Ts0pi";
(2450,-1150)*+{\T_\Phi [ R ] }="Tt0pi";
{\ar "Tspi";"Tpi"};
{\ar "Ttpi";"Tpi"};
{\ar|(0.6){\hole} "Ts0pi";"Tspi"};
{\ar|(0.713){\hole} "Tt0pi";"Tspi"};
{\ar "Ts0pi";"Ttpi"};
{\ar "Tt0pi";"Ttpi"};
%
% Connecting wires:
%
{\ar "g2";"Tpi"};
{\ar
  |(0.277){\hole}
  ^(0.57){\Sterm\; \mapsto\; P,\ \  \Tterm\;\mapsto\;R,}
  |(0.555){\;\cterm_1(x)\ \mapsto\ g(f(x))\,:\,R\;}
  "g1l";"Tspi"};
{\ar
  |(0.23666){\;\Sterm\;\mapsto\;P,\ \  \Tterm\;\mapsto\;R,\;}
  _(0.256){\cterm_1(x)\ \mapsto\ g'(f'(x))\,:\,R }
  "g1r";"Ttpi"};  % to line up perfectly with others, use (0.23666)
{\ar|(0.235){\hole}|(0.333){\hole}|(0.57){\; \Cterm\ \mapsto\ P\; }  "g0l";"Ts0pi"};
{\ar|(0.23666){\;\Cterm\ \mapsto\ R\;} "g0r";"Tt0pi"};
\endxy
\]
while the apex map interprets $\Sterm$ as $P$, $\Tterm$ as $R$, $\sterm_1(x)$ as $f(g(x))$, $\tterm_1(x)$ as $f'(g'(x))$ (all as forced by the lower dimensions of the span), and $\cterm_2(x)$ as the term
\[ \Jterm_{y,y': Q,\,u : \Id_Q(y,y').\;\Id(g(y),g'(y'))} (\,y.\beta(y);\ f(x),\,f'(x),\,\alpha(x)) \]
of type $\Id_R(\,g(f(x))\,,\,g'(f'(x))\,)$.  (The reader tempted to try actually reading this term is encouraged to re-derive it herself instead: this will certainly be more enlightening, and probably also easier.) 
\end{para}

\begin{para} Since the cells involved in $\T[\pi]$ are generic, this operation can be implemented as a composition law in any type theory with $\Id$-types.  Generally, by \ref{para:homming-out}, $\End(\globes)$ acts naturally on $\cl^-_{\omega}$, allowing us to lift $\cl^-_\omega$ to a functor into $\Alg{\End(\globes)}$ which by abuse of notation we again denote $\cl^-_\omega$:

\[\bfig
\node DTT(0,0)[\DTT_\stuff]
\node EndGAlg(1200,500)[\Alg{\End(\globes)}]
\node GSets(1400,0)[\GSets]
%\node wkwCat(900,500)[\wkwCat]
\arrow[DTT`GSets;\cl^-_\omega]
\arrow[DTT`EndGAlg;\cl^-_\omega]
%\arrow[EndGAlg`wkwCat;]
\arrow[EndGAlg`GSets;U]
%\arrow[wkwCat`GSets;]
\efig\]

Moreover, since $U$ reflects and the original $\cl^-_\omega$ preserves all limits, so does the lifted $\cl^-_\omega$, and it is easily seen to be finitary; so by the adjoint functor theorem for locally presentable categories \cite[1.66]{adamek-rosicky}, $\cl^-_\omega$ has a left adjoint, realising any $\End(\globes)$-algebra as a theory.  (Its cells are realised as types and terms as under $\T_\stuff[-]$, and the $\End(\globes)$-action specifies various definitional-equality axioms between them.)
\end{para}

\begin{para} \label{para:class-types-to-cxts} As mentioned before, this is not quite what we want; $\cl^-_\omega(\T)$ only has types as objects, where we would like contexts.  To remedy the situation, we can compose with the ``types to contexts'' endofunctor $(-)^\cxt \slice \diamond$ on $\DTT_\stuff$, and define $\cl(\T) := \cl^-_\omega(\T^\cxt \slice \diamond)$.

Now the objects of $\cl(\T)$ are closed types of $\T^\cxt \slice \diamond$, i.e.\ closed contexts of $\T$, just as we wanted; and the fullness of the functor $\T^\cxt \slice \diamond \to \T$ ensures that higher cells also are as we intended.

This adjustment is not quite so ad hoc as it may appear: if $(-)^\cxt slice \diamond$ were indeed a monad (as it very nearly is), then $\cl_\omega$ would itself be a representable functor, on the Kleisli category of $(-)^\cxt slice \diamond$.
\end{para}

\begin{para} \label{para:map-from-pcat} In Section \ref{sec:contractibility} below, we will investigate the question of when $\End(\globes)$ is contractible, or at least of finding a contractible suboperad.  This will require, however, the development of some more type-theoretic machinery.  For now, we may content ourselves with showing that at least in dimensions $\leq 1$, $\End(\globes)$ is very nice.

Specifically, recall from \ref{para:normalised-core} the discrete/truncation/indiscrete adjunctions
\[ \nOpd[1] \three/->`<-`->/^{D}|{\tr^1}_{I} \nOpd[\omega]\].

Now take $P_\Cat \in \nOpd[1]$ to be the operad for categories, i.e.\ the terminal 1-operad.  Then there is a map $\psi \colon P_{\Cat} \to \tr^1 \End(\globes)$ (or equivalently $D(P_{\Cat}) \to \End(\globes)$), so that truncating algebras and pulling back along this map induces a map $\Alg{\End(\globes)} \to \Cat$, which when applied to $\cl_\omega(\T)$ recovers the classifying category $\cl(\T)$:
\[\bfig
\node DTT(0,0)[\DTT_\stuff]
\node EndGAlg(1000,500)[\Alg{\End(\globes)}]
\node trEndGAlg(2000,500)[\Alg{\tr^1 \End(\globes)}]
\node Cat(2800,500)[\Cat]
\node GSets(1400,0)[\GSets]
\node G1Sets(2400,0)[{\GnSets[1]}]
\arrow[DTT`EndGAlg;\cl_{\omega}]
\arrow[EndGAlg`trEndGAlg;\tr^1]
\arrow[trEndGAlg`Cat;\psi^*]
\arrow[EndGAlg`GSets;]
\arrow[trEndGAlg`G1Sets;]
\arrow[Cat`G1Sets;]
\arrow[DTT`GSets;\cl_{\omega}]
\arrow[GSets`G1Sets;\tr^1]
\arrow/@{>}@/^0em//[DTT`Cat;\cl]
\efig\]

This points us towards an easy abstract construction of the map $\psi$.  We know that the 1-globular object $\globe[0] \two/<-`<-/ \globe[1]$ represents the original classifying category functor $\cl : \DTT_\stuff \to \Cat$; so by the Yoneda lemma, $\globe[0] \two/<-`<-/ \globe[1]$ must carry some co-category structure; but such a structure corresponds exactly to an operad map of the form we want, since $\tr^1 \End(\globes) \iso \End(\tr^1 \globes)$.
\end{para}

\begin{para} \label{para:map-from-cat} However, constructing $\psi$ concretely gives us an excuse to analyse low dimensions of $\End(\globes)$.  A 0-dimensional operation in $\End(\globes)$ is perforce just a unary map $\globe[0] \to \globe[0]$ (there is only one 0-dimensional pasting diagram); so the single 0-dimensional operation in $\Cat$ (the identity on 0-cells) we send to the identity map $1_{\globe[0]}$.  (There is no freedom here: $\psi$ must preserve the operad structure, and $1_{\globe[0]}$ is the $0$-dimensional operad unit of $\End(\globes)$.)

A 1-dimensional pasting diagram is just a path $\pathpd_l = (\cdot \to<200> \cdot \to<200> \ldots \to<200> \cdot)$ of some length $l \geq 0$.  \todo{[NOTATION!? $\pathpd_l$ is awful!]} An operation of shape $\pathpd_l$ in $\End(\globes)$ with source and target $1_{\globe[0]}$ is a map of cospans
\[\bfig
%%%%%%%%%%%%%%%%%%%
% left hand pylon %
%%%%%%%%%%%%%%%%%%%
\node gn(250,0)[\globefig{1}]
\node gn1l(0,-250)[\globefig{0}]
\node gn1r(500,-400)[\globefig{0}]
\arrow[gn1l`gn;s]
\arrow[gn1r`gn;t]
%%%%%%%%%%%%%%%%%%%%
% right hand pylon %
%%%%%%%%%%%%%%%%%%%%
\node Tpi(1750,0)[{\T_\stuff[\widehat{\pathpd_l}]}]
\node Tspi(1500,-250)[{\globefig{0}}]
\node Ttpi(2000,-400)[{\globe[0]}]
\arrow[Tspi`Tpi;s]
\arrow[Ttpi`Tpi;t]
%%%%%%%%%%%%%%%%%%%%
% connecting wires %
%%%%%%%%%%%%%%%%%%%%
\arrow[gn`Tpi;H]
\arrow/@{=}|!{(250,0);(500,-400)}\hole/[gn1l`Tspi;]
\arrow/@{=}/[gn1r`Ttpi;]
\efig\]

But $\T_\stuff(\pathpd_l)$ admits a very simple axiomatisation
\[
\inferrule{\ }{\diamond\ \types\ A_i\ \type} \quad (0 \leq i \leq l) \qquad 
\inferrule{\ }{\x:A_{j-1}\ \types\ f_j(a) : A_j } \quad (1 \leq j \leq l) 
\]
simply adjoining basic types and type formers
\[ \xymatrix{ A_0 \ar[r]^{f_1} & A_1 \ar[r]^{f_2} & \ \ar@{}[r]|{\ldots} & \ \ar[r]^{f_l} & A_l} .\]

The source and target maps of the right-hand cospan interpret the type of $\globe[0]$ as $A_0$ and $A_l$ respectively; so suitable maps $H : \globe[1] \to \T_\stuff[\widehat{\pathpd_l}]$ correspond to interpretations of the type-constructor of $\globe[1]$ as some term
\[ x : A_0 \ \types\ t(x) : A_l \]
For the unique $l$-ary operation of $P_\Cat$, we thus use the obvious composite term $f_l(f_{l-1}(\ldots (f_1(x))\ldots))$.  It is routine to check that this indeed gives an operad map.
\end{para}

\begin{para} \label{para:canonicity-in-Tpath} When $\stuff$ gives a particularly well-behaved type system, we can say a little more.

In the case when $\stuff$ consists of just the $\Id$-rules, then firstly $\globe[0]$ has no other closed types besides the basic $C$, so $1_{\globe[0]}$ is its only endomorphism, and the only element of $\End(\globes)$ in dimension $0$; and secondly, \todo{\cite{canonicity-reference?}} $\T_\stuff[\widehat{\pathpd_l}]$ enjoys both normalisation and \emph{canonicity}\footnote{canonicity: the property that every closed normal form is an intro (aka canonical) form; there are no stuck (aka neutral) normal forms}, so the ``obvious term'' we used was in fact the only possible such term: there is only one $l$-ary operation in $\End(\globes)$ with source and target $1_{\globe{0}}$.

So in this case, the map $P_\Cat \to \tr^1\End(\globes)$ (always injective, since $P_\Cat$ is terminal) is moreover surjective, and gives an isomorphism $\tr^1\End(\globes) \iso P_\Cat$.

In richer type systems, $\globe[0]$ will typically have more closed types (e.g.\ $C \rightarrow C$), and hence $\End(\globe[0])$ will have more $0$-dimensional operations.  But in important cases, such as when $\stuff$ consists of just the $\Id$- and $\Pi$-rules, we retain normalisation and canonicity for $\T_\stuff[\widehat{\pathpd_l}]$, so by the argument above our map is at least an isomorphism from $P_\Cat$ to the \emph{normalised core} of $\End(\globes)$. 
\end{para}


\subsection*{A variant for \pdfPi-types}  % A house for Mr. Biswas?  A penny for a song?

\begin{para} We can also consider a variant set of globes ${}^\Pi \globes^\stuff$, for any set of constructors $\stuff$ including $\Pi$-types.  The axioms for each $\piglobe$ are selected from rules $i$-$\sourcerule$-$\Pi$, $i$-$\targetrule$-$\Pi$, $i$-$\cellrule$-$\Pi$, analogously to the axioms for $\globe$.  These axioms differ from before in dimensions $\geq 1$, by using closed rather than open terms:
\[ 
\inferrule*[right={1-$\sourcerule$-$\Pi$}]{\ }{\diamond \types s_1: \Pi_{x:S_0}\, T_0} \qquad
\inferrule*[right={$i$-$\sourcerule$-$\Pi$}]{\ }{\diamond \types s_i:\Id_{\Pi_{x:S_0} T_0} \Id(s_{i-1},t_{i-1})} \qquad \mbox{etc.}
\]

As before, we get a Kan adjunction
\[ \GSets \two/->`<-/^{\T_\stuff[-]^\Pi}_{{}^\Pi \cl^-_\omega} \DTT_\stuff \]
and lift $\clpi^-_\omega$ to $\Alg{\End({}^\Pi \globes)}$; also as before, we ``correct'' the functor $\clpi^-_\omega$ by precomposing with $(-)^\cxt \slice \diamond$, to get an alternate candidate for the classifying weak $\omega$-category:
\[ \clpi_\omega \colon \DTT_\stuff \to \Alg{\End({}^\Pi \globes)}\]

The objects of $\clpi_\omega (\T)$ are the same as those of $\cl_\omega(\T)$.  The difference is in the higher cells: rather than open context maps, $1$-cells are now context maps from the empty context $\diamond$ into ``$\Pi$-contexts'', and higher cells are context maps from $\diamond$ into the identity contexts over these.

Thus, while not exactly what we first thought of, this is a reasonable alternative candidate for the ``classifying weak $\omega$-category''. 
\end{para}

\begin{para}
There is an evident map of globular objects $\globes \to \piglobes$, interpreting the open term-constructors of $\globes$ by applications of the closed terms of $\Pi$-type in $\piglobes$.  This induces a natural map $\cl_\omega^\Pi(\T) \to \cl_\omega(\T)$.

In theories with $\Pi$-$\extrule$, there is also a map $\piglobes \to \globes$ coming the other way.  In the presence of $\Piextapp$-$\defrule$, these maps exhibit $\piglobes$ as a retraction of $\globes$, and hence $\clpi_\omega$ as a retract of $\cl_\omega$.
\end{para}

\begin{para} \label{para:canonicity-for-piglobes}
We would also like to repeat the construction of \ref{para:map-from-pcat} and construct a map
\[{}^\Pi \psi \colon P_\Cat \to \tr^1 \End(\piglobes),\]
and indeed we can do so, under the further assumption that $\Phi$ also contains the (definitional) $\eta$-rule for $\Pi$-types.  In this case, we interpret the $l$-ary operation using the map $\piglobe[1] \to \T_\Phi[\widehat{path}_l]$ which interprets the basic term $c_1: S_0 \rightarrow T_0$ as the composite term $\lambda x \tightcolon S_0.\ (c_l \tightcdot (c_{l-1} \tightcdot \ldots (c_1 \tightcdot x)\ldots))$.  This certainly preserves the operad composition; the $\eta$-rule required to ensure that it preserves the operad unit, i.e.\ that in the case $l=1$, the resulting operation (sending $c_1$ to $\lambda x.\, c_1 \tightcdot x$) is just the identity on $\piglobe[1]$.

In the case where $\stuff$ is exactly $(\Id, \Pi, \Pi\mbox{-}\eta)$, then both normalisation and canonicity hold \todo{\cite{normalisation-reference}}, but $C_0$ is not the only closed type of $\piglobe[0]$.  So ${}^\Pi \psi \colon P_\Cat \to \tr^1 \End(\piglobes)$ is not an isomorphism in this case, as it is not surjective on $0$-cells; but it is at least full on $1$-cells.  
\end{para}










\section{Homotopical structures on \pdfDTT} \label{sec:homot-strux-on-dtt} \subsection*{Left and right maps in \pdfDTT}

\begin{para} In this section, we will set up various classes of left and right maps on $\CwA^{\stuff}_\diamond$, with a view to applying the methods of \ref{thm:p-is-contractible} to find a contractible operad acting on the globes.

As remarked in the introduction to this chapter, we will succeed only for theories with $\Pi$-types and some extensionality rules.  However, only one step of the proof (showing that the reflexivity maps $\T_\stuff[\widehat{\pi}] \to \T_\stuff[\widehat{\pi^-}]$ are right maps) uses these extra rules; and it seems hopeful that a similar approach could also apply for theories with only $\Id$-types.

We therefore isolate and investigate a certain property of type systems, $\Jbar$, which suffices for the proof of this step, and which seems to be of independent interest.  We discuss equivalent statements of $\Jbar$ from several rather different points of view: as a conservativity statement for certain theory extensions; as a second-order form of the $\Id$-elim rule; and as a form of observational equality for $\Pi$-types.  $\Jbar$ turns out to be derivable in theories with the $\Piextapp$ rules; it seems plausible, but elusive, that it is admissible for theories with just $\Id$-types; and it may fail over intermediate theories.
\end{para}

\begin{para}[Type and term extensions]
For the remainder of this section, fix some collection $\stuff$ of the constructors and rules of \ref{para:constructors}, and work in $\DTT_\stuff$.  (The main cases of interest in the sequel are where $\stuff$ is either $(\Id)$, $(\Id,\Pi,\eta)$, or $(\Id,\Pi,\Piext,\Piextapp)$.)

For $n \geq 0$, we define theories $\T_\stuff[\Gamma_{(n)}]$, $\T_\stuff [\Gamma_{(n)} \types A]$, and $\T_\stuff [\Gamma_{(n)} \types a : A]$ to be the free theories on, respectively, a context of length $n$; a dependent type, in context of length $n$; and a term in such a type.  Axiomatically, each may be  specified by some subset of the rules below: $\T_\stuff[\Gamma_{(n)}]$ by the rules $i$-$\cxtrule$, for $0 \leq i < n$; $\T_\stuff [\Gamma_{(n)} \types A]$, by these rules together with $n$-$\typerule$; and $\T_\stuff [\Gamma_{(n)} \types a : A]$ by all of the above, together with $n$-$\termrule$:
\[\inferrule*[right={$i$-$\cxtrule$}]{\Gamma \types a_0:A_0\ \ldots\ \Gamma \types a_{i-1}:A_{i-1}}{\Gamma \types A_i(a_0,\ldots,a_{i-1})\ \type} \qquad \inferrule*[right={$i$-$\typerule$}]{\Gamma \types a_0:A_0\ \ldots\ \Gamma \types a_{i-1}:A_{i-1}}{\Gamma \types A(a_0,\ldots,a_{i-1})\ \type}\]
\[\inferrule*[right={$i$-$\termrule$}]{\Gamma \types a_0:A_0\ \ldots\ \Gamma \types a_{i-1}:A_{i-1}}{\Gamma \types a(a_0,\ldots,a_{i-1}) : A_i(a_0,\ldots,a_{i-1})}\]

(Of course, we have $\T[\Gamma_{(n-1)} \types A] \iso \T[\Gamma_{(n)}]$; we retain the distinction just for notational clarity.)
\end{para}

\begin{para} The importance of these theories lies in their universal mapping properties.  For any theory $\T$, maps $\T_\stuff[\Gamma_{(l)}] \to \T$ correspond precisely to contexts of length $n$ in $\T$; maps $\T_\stuff[\Gamma_{(l)} \types A\ \type] \to \T$, to types over such a context; and maps $\T_\stuff[\Gamma_{(l)} \types a:A] \to \T$ to terms of such a type.

An analogy can profitably be drawn here between type theories and higher categories.  Globular higher categories are made up of cells, which are \emph{represented} by the free $n$-categories on individual cells.  Similarly, type theories are made up of judgements---contexts, types, and terms---which are represented by the theories above.

But now, many important aspects of higher category theory---in particular, their homotopical structure---can be described in terms of the inclusions of boundaries into those basic cells.  Much of this carries over substantially to type theories once we observe that \emph{judgements have boundaries too}  ---indeed, this idea is already implicit in referring to e.g.\ $\Gamma \types a:A$ as a \emph{term judgement}: we are thinking of $a$ as the essential substance of the judgement, and the function of $\Gamma$ and $A$ as just to situate $a$ within its surroundings, as seen in the form of the algebraic rules of \ref{para:alg-rules}.
\end{para}

The ``inclusions of boundaries into cells'' are defined as follows:

\begin{definition}
The \emph{universal type (resp.\ term) extensions} are the inclusion maps
\[ i^\ty_n \colon \T_\stuff [\Gamma_{(n)}] \mono \T_\stuff[\Gamma_{(n)} \types A],\]
\[ i^\tm_n \colon \T_\stuff [\Gamma_{(n)} \types A] \mono \T_\stuff[\Gamma_{(n)} \types a : A].\]

A \emph{basic term/type extension} is a pushout of one of the universal extensions.  A \emph{term/type/term-and-type extension} is any composite (possibly transfinite) of basic extensions.

We indicate such extensions in diagrams by tailed arrows: $\T \mono \S$.  
\end{definition}

So in syntactic terms, a basic term extension is just any extension of a theory $\T$ by a new term-constructor 
\[x_1: A_1,\ \ldots,\ x_{n-1} : A_{n-1}(\x^{< n-1})\ \types\ a(\x) : A_n(\x),\]
where the $A_i$ (for $i = 1,\ldots\,n$) are existing types of the theory.  Similarly, a basic type extension is an extension by a single algebraic type-forming axiom.  A general term/ype/term-and-type extension is any extension of theories formed by iteratively adding (arbitrary sets of) axioms of these forms.

In the langage of Section \ref{sec:wfs-bgd}, the classes of term, type, and term-and-type extensions are just classes of $\J$-cell complexes for evident suitable choices of $\J$.  As such, they are immediately closed under composition, identities, and pushouts.

\begin{definition} \label{def:dtt-contraction} A \emph{term-contraction} (resp.\ \emph{type-contraction}, \emph{contraction}) on a map $F \colon \T \to \S$ is a $\J^\boxslash$-structure, where $\J$ is the set of universal term (resp.\ type, term and type) extensions.  Explicitly, it is a function assigning a diagonal filler to every square
\[\xymatrix{ \T_\stuff[\Gamma_{(n)} \types A\ \type] \ar@{ >->}[d]_{i^\tm_n} \ar[r] & \T \ar@{-|>}[d]^F \\ \T_\stuff[\Gamma_{(n)} \types a: A] \ar[r] \ar@{.>}[ur] & \S }\]
with left-hand-side a universal type (term, term or type) extension.

A map admitting such structure is called \emph{term-contractible} (\emph{type-contractible}, \emph{contractible}); assuming choice, this is equivalent to being weakly orthogonal to all universal term (type, term and type) extensions.

We will write $\R_\tm$, $\R_\ty$, $R_{\tm\ty}$ for the classes of contractible maps, and indicate them in diagrams by double-headed arrows: $\T \to/-|>/ \S$.  
\end{definition}

\begin{para} \label{para:ctrble-remarks} By \ref{para:awfs}, a type-contractible (term-contractible, contractible) map in fact has canonical liftings against all type (term, term-and-type) extensions; and the classes $\R_\tm$, $\R_\ty$, $\R_\ty$ are closed under identities, transfinite composition, pullbacks, and retracts.

Also, the universal extensions were axiomatised purely algebraically over the structural core, with no specific constructors required.  In other words, for any $\stuff$, the universal extensions in $\DTT_\stuff$ are the image under the left adjoint $F \colon \DTT \to \DTT_\Phi$ of the universal extensions in $\DTT$.

It follows immediately that contractions and contractibility are preserved and reflected by the forgetful functor $U \colon \DTT_\Phi \to \DTT$, right adjoint to $F$.
\end{para}

\begin{para} Contractibility is familiar in syntactic terms as a form of conservativity.  Term-contractibility of a translation $F \colon \T \to \S$, for instance, states that whenever we have a type $\Gamma\, \types_\T\, A\ \type$ of $\T$ whose interpretation in $\S$ is inhabited by some term $F(\Gamma)\, \types_\S\, a:F(A)$, it is already inhabited in $\T$ by some term $\Gamma\, \types_\T\, \overline{a}:A$, which moreover is a \emph{lifting} of $a$, in that we can prove $F(\Gamma)\, \types_\S\, F(\overline{a}) = a : F(A)$ in $\S$.  Type-contractibility asserts the same sort of lifting property for types derivable in $\S$ over a context from $\T$.

This syntactic formulation of type-contractibility has been considered previously by Hofmann as a conservativity principle: see the discussion of logical frameworks in \cite[\SEC 4]{hofmann:syntax-and-semantics}, and Example \ref{ex:hofmann-contractibility} below.
\end{para}

\begin{para} Note that while neither form of contractibility directly provides any kind of lifting for definitional equality judgements, in the presence of identity types one can obtain weak forms of such liftings just from term-contractibility.  If for instance $\Gamma\, \types_\T\, a,a': A$ and $F(\Gamma)\, \types_\S\, F(a) = F(a'):F(A)$, then term-contractibility lets us lift $r(F(a))$ to some term $\Gamma\, \types_\T\, \overline{r(F(a))} : \Id_A(a,a')$.  

Essentially, definitional equality for terms implies propositional equality, and for types, isomorphism-up-to-propositional-equality (``homotopy-equivalence''); and since these are matters of term-judgements, they can be lifted along a term-contractible map. 

Often, term-contractibility implies type-contractibility.  In particular, in many important theories, the type-forming axioms do not mention any of the specific term-constructors. From this it follows that if $F \colon \T \to \S$ is a morphism between two such theories, where $\S$ has the same type-forming rules as $\T$, then if $F$ is term-contractible, it is also type-contractible.  However, we will not need this fact in the sequel.
\end{para}

\begin{example} \label{ex:elim-gives-contraction}
For any context morphism $f : \Delta \to \Theta$, the induced map of slices $f^*\colon \T \slice \Theta \to \T \slice \Delta$ is orthogonal to $i^\tm_0$ just if $f$ admits an elim-structure as defined in \ref{def:elim-structure} above---that is, if $f$ is a left map in the sense of Gambino--Garner \cite{gambino-garner}---or syntactically, if $f$ admits an ``elimination rule'' (and associated computation rule):
\[\inferrule{\y : \Theta \types C(\y)\ \type \\ \z:\Delta \types d(\z): C(f(\z))}{\x : \Theta\ \types\ \mathsf{elim}_f(\y.C, \z.d; \x) : C(\x)}\]

\[\xymatrix{ 
  \T_\stuff[\diamond \types A\ \type] \ar@{ >->}[d]_{i^\tm_0} \ar[r]^C 
  & \T \slice \Theta \ar@{-|>}[d]^{f^*} 
\\ 
  \T_\stuff[\diamond \types a: A] \ar[r]^d \ar@{.>}[ur]|{e_{C,d}}
  & \T \slice \Delta
}\]

It is fully term-contractible exactly if every pullback of $f$ along a dependent projection is a Gambino--Garner left map, or equivalently if it supports the ``Frobenius'' form of this elimination rule, with extra dependent premises in the context, i.e.\ 
\[\y : \Theta, w: \Xi(\y) \types C(\y,\w)\ \type \ldots\]

This follows from $f$ alone being a left map as long as $\T$ has $\Pi$-types (by standard arguments), or identity types (by \cite[5.2.1]{gambino-garner}).

In particular, for every reflexivity map $\r \colon \Delta.B \to \Delta.B.B.\Id_B$, the map $r^*$ between slices is term-contractible; similarly for the one-ended variant of $\Id$-elim.

Analogously to the above, ``large elimination'' rules give type-contractibility; but this will not concern us here.
\end{example}

\begin{example} \label{ex:hofmann-contractibility}
As remarked above, if $\T$ is any theory over some standard type system and $\T^\mathrm{\LF}$ is its presentation in a logical framework, then according to \cite[\SEC 4]{hofmann:syntax-and-semantics}, the interpretation of $\T$ in $\T^\mathrm{\LF}$ is type-contractible.

More precisely, many standard type systems $\Phi$ (including all the combinations of rules and constructors we have considered) admit, in a uniform manner, a presentation by purely algebraic rules over the \emph{logical framework} system $\LF$ (consisting, roughly, of strong $\Pi$-types and a single universe), and moreover (soundness of the presentation) each theory $\T$ has a natural interpretation into its $\LF$ presentation $\T_{\LF}$.  In categorical terms, we have a functor $\DTT_\Phi \to \DTT_{\LF}$, and natural transformation
\[\bfig
\node DTTPhi(0,450)[\DTT_\Phi]
\node DTTLF(700,450)[\DTT_{\LF}]
\node DTT(350,0)[\DTT]
% start with (175,225) --> (700,450), i.e. slope 525:225 = 7:3.  
% shorten by (49,21), (196,82)
\node a(224,236)[]
\node b(504,368)[]
\arrow[DTTPhi`DTTLF;(-)_{\LF}]
\arrow|l|[DTTPhi`DTT;U]
\arrow|r|[DTTLF`DTT;U]
\arrow/@{=>}/[a`b;]
\efig\]
Then the results of \cite[\SEC 4]{hofmann:syntax-and-semantics} state that the components $\T \to \T_{\LF}$ of this natural transformation are type-contractible. (Recall from \ref{para:ctrble-remarks} that contractibility of a map of theories is independent of what system it is considered over.)

In fact, although not explicitly stated there, the proof given also shows (since the presheaf model is full) that these translations are \emph{faithful}: we can lift not only terms, but \emph{definitional} equalities between them.
\end{example}

\begin{para} Since $\DTT$ is the category of models of an algebraic theory, and so is locally presentable, we can use the machinery of \cite{garner:understanding} (the ``algebraic small-object argument'') to construct an algebraic weak factorisation system\footnote{aka natural weak factorisation system} on $\DTT$, using the universal extensions (term, type, or both) as the generating left maps.  The algebraic right maps in the resulting system are then just maps equipped with (term-, type-) contractions; the algebraic left maps are maps presented as (term, type, term-and-type) extensions.

We can think of the maps $i^\ty_n$, $i^\tm_n$ here as \emph{generating cofibrations} in a putative model structure on $\DTT$, and the contractible maps as the \emph{trivial fibrations}; this idea is discussed a little further in Section \ref{sec:model-strux} below.

Example \ref{ex:elim-gives-contraction} suggests that this factorisation system on $\DTT$ is in some sense dual to the Gambino--Garner systems on the classifying categories of individual theories.  We will make this idea more precise in Section \ref{sec:fam-strux-on-DTT}.
\end{para}






\subsection*{Extensions by propositional copies: the conservativity principle \texorpdfstring{$\Jbar$}{J-bar}.}

\begin{para}
One of the fundamental lemmas for many logical systems is that \emph{extension by definitions} should be well behaved: that if we extend a theory $\T$ by adding a new term $a'$, and an axiom that $a'$ is equal to some pre-existing term $a$ of $\T$, then the resulting theory is in some sense equivalent to $\T$.

For dependent type theories, this is clear when the new constructor is posited to be \emph{definitionally} equal to an existing one: the resulting theory $\T[a':= a]$ is isomorphic to $\T$ itself.

However, one may also wish to understand a weaker situation, where the new term is only posited to be \emph{propositionally} equal to the existing one; that is, where we extend $\T$ by axioms
\[\inferrule{\ }{\x : \Gamma \types a'(\x) : A(\x)} \qquad \inferrule{\ }{\Gamma \types l(\x) : \Id_A(a'(\x),a(\x)) }\]
Briefly, denote the resulting theory by $\T[a' :\propeq a]$, or when more detail is needed, by $\T[\x: \Gamma\ \types\ a'(\x) :\propeq_{l(\x)} a(\x) : A(\x)]$ or similar.

Categorically, extensions of this form are precisely pushouts of the universal ones 
\[\T_\stuff[\Gamma_{(n)} \types a: A] \mono \T_\stuff[\Gamma_{(n)} \types a: A][a' :\propeq a].\]
We will call (possibly transfinite) compositions of such pushouts \emph{extensions by propositional copies}, and write them as $\T[a_i'(\x) :\propeq a_i(\x)]$.  We are once again dealing with a class of relative cell complexes, so it is, as ever, closed under pushouts and (transfinite) composition.

Note also that each of the source or target inclusions $\globe[n] \mono \globe[n+1]$, for $n \geq 1$, is an extension by propositional copies.
\end{para}

What can we now say about the inclusion $\T \mono \T[a'(\x) :\propeq a(\x)]$?  It is certainly not an isomorphism in general, nor indeed contractible, since $a'$ will generally not be in its image.  On the other hand, it is by definition a term-extension.  It is also certainly a monomorphism, since it has a retraction $\T[a'(\x) :\propeq a(\x)] \epi \T$, given by interpreting $a'$ as $a$ and $l$ as $r(a)$.

Our principle $\Jbar$ describes one sense in which $\T[a'(\x) :\propeq a(\x)]$ may reasonably be equivalent to $\T$:

\begin{definition}Say that \emph{$\Jbar$ holds for $\stuff$} if for every extension by propositional copies, the retraction $\T[a'(\x) :\propeq a(\x)] \epi \T$ is term-contractible.
\end{definition}

% In categorical terms, the retractions of the universal such extensions
% \[\T_\stuff[\Gamma_{(n)} \types a: A] \mono \T_\stuff[\Gamma_{(n)} \types a: A][a'(\x) :\propeq a(\x)].\]
%are absolutely term-contractible.  \todo{[Actually, ``absolutely term-contractible'' isn't quite right: that would imply $\overline{K}$!  Subtlety is in what kinds of pushouts we're considering.  Can this phrasing of $\Jbar$ be corrected?  Think on it, throw it out if not.]}

(Actually, we will not need the full strength of the principle as stated here: for our purposes, it would be enough to show that this holds when $\T$ can be axiomatised over $\stuff$ without any definitional equality axioms, i.e.\ when $\T_\stuff \mono \T$ is a term-extension, or in homotopy-theoretic language, when $\T$ is a \emph{cofibrant} theory.)

Why is this a plausible principle?  If we restrict to the case of adjoining copies of \emph{closed} terms, i.e.\ in the case where $\Gamma = \diamond$, then it is just (the one-ended form of) the $\Id$-$\elim$ rule.  Syntactically, this is the fact that working in an extension by closed terms is equivalent to working over an extended context, with the new variables.  Categorically, the extension and its retraction in this case are isomorphic to the maps of slices
\[\bfig
\node Ta'a(0,400)[{\T[a' :\propeq a]}]
\node Tbyxu(1200,400)[\T \slice (x:A, u:\Id(x,a))]
\node T(0,0)[\T]
\node TbyD(1200,0)[\T \slice \diamond]
\arrow|m|/<->/[T`TbyD;\iso]
\arrow/@{ >->}@/^0.4em//[T`Ta'a;]
\arrow/@{-|>}@/^0.4em//[Ta'a`T;]
\arrow/@{ >->}@/^0.4em//[TbyD`Tbyxu;]
\arrow/@{-|>}@/^0.4em//[Tbyxu`TbyD;]
\arrow|m|/<->/[Ta'a`Tbyxu;\iso]
\efig\]
induced by the retraction of contexts
\[\bfig
\node diamond(0,0)[\diamond\ ]
\node xu(850,0)[(x:A, u:\Id(x,a))]
\arrow|a|/@{ |>->}@<0.3em>/[diamond`xu;a,r(a)]
\arrow|b|/@{->>}@<0.3em>/[xu`diamond;!]
\efig .\]

Then the map $(a,r(a)) \colon \diamond \mono x:A, i:\Id(x,a)$ is the introduction map for an instance of the one-ended form of $\Id$-$\elim$, so by Example \ref{ex:elim-gives-contraction}, the retraction  of slices $(a,r(a))^*$ is term-contractible.

Thus $\Jbar$ asserts that something which holds \emph{derivably} for closed terms also holds \emph{admissibly} for open terms: in particular, that open terms of identity types satisfy the same rules as closed ones do. \oldtodo{I had here: ``$\Jbar$ asserts---like various other type-theoretic principles---\ldots'', but I now can't remember what other examples I originally had in mind.}

Unlike most type-theoretic principles, is important to note, however, that $\Jbar$ is \emph{not} a property of a theory in isolation, but of a \emph{category} of theories, of what I have here called a type system.\\

So one way to prove $\Jbar$ is therefore to reduce the general case to the closed case, via $\Pi$-types.  This is possible, as long as we assume enough $\ext$ rules to make sure that their identity types are well-behaved:

\begin{proposition} \label{prop:jbar-holds-1}
$\Jbar$ holds for $(\Id,\Pi,\Pi\mbox{-}\extrule,\Piextapp\mbox{-}\defrule)$ and any set of constructors extending this.
\end{proposition}

\begin{proof}
The diagram
\[\bfig
\node Ta(0,400)[{\T[a'(\x) :\propeq a(\x) : A(\x)]}]
\node Tf(1600,400)[{\T[f :\propeq (\lambda \x.\ a(\x)) : \Pi_{\x} A(\x)]}]
\node T1(0,0)[\T]
\node T2(1600,0)[\T]
\arrow/@/^0.4em//[Ta`Tf;]
\arrow/@/^0.4em//[Tf`Ta;]
\arrow[Ta`T1;]
\arrow/@{-|>}/[Tf`T2;]
\arrow/@{=}/[T1`T2;]
%%% \arrow|a|/@{ >->}@/^0.4em//[Ta'`Tf;]
%%% \arrow|b|/@{->>}@/^0.4em//[Tf`Ta';]
\efig\]
% \[\xymatrix{\T[k(\x):K(\x)] \ar[d] \ar@/_/[r] & \ar@/_/[l] \T[\hat{k}:\Pi_{\x} K(\x) \ar[d] \\ 
% \T[k_0(\x),k_1(\x):K(\x),\ l(\x):\Id(k_0(\x),k_1(\x))] \ar@/_/[r] & \ar@/_/[l] \T[\hat{k}_0,\hat{k}_1 : \Pi_{\x} K(\x),\ \hat{l}:\Id(\hat{k}_0,\hat{k}_1)]}\]
exhibits its left-hand side (the map we wish to show contractible) as a retract of its right-hand side.  (The fact that the squares commute and are a retraction require the computation rules for $\extterm$.)  But the right-hand side is just the closed case of $\Jbar$, which we've seen is contractible.
\end{proof}

However, $\Piextapp\mbox{-}\defrule$ is a very \emph{strict} rule: it holds in for instance the groupoid model, but one would not expect it to hold in most weak higher-categorical models.  Happily, though, with a little more work the hypotheses here can be weakened.

Another way to see $\Jbar$ is as a close cousin of Garner's rule $\PiIdelim$.  Recall that this latter asserts that a version of $\Id$-elimination holds over products of identity types $\Pi_x\ \Id(f \tightcdot x, g \cdot x)$: that these types are inductively generated by the terms $\lambda x. r(f \cdot x)$.  But terms of such types are very close to the open terms of $l(\x)$ of identity type that appear in $\Jbar$---and the connection may be made clear by working in a second-order formulation, using a logical framework as metalanguage.  In these terms, a second-order version of $\Jbar$ can be seen as being a strong functional extensionality principle, similar to $\PiIdelim$, but stated without $\Pi$-types.   It is then not hard to show that this form of $\Jbar$ is derivable from $\PiIdelim$, and so:

\begin{proposition}\label{prop:jbar-holds-2}
$\Jbar$ holds for $(\Id,\Pi,\Piext,\Piextapp)$, and more generally for any set of constructors which implies $\PiIdelim$ and satisfies Hofmann's conservativity theorem \ref{ex:hofmann-contractibility} for logical frameworks.
\end{proposition}

\begin{proof}
Recall the statement of the rule $\PiIdelim$:

\[ \inferrule*[right={$\PiIdelim$}]{
\Gamma,\ u, v : \Pi_{x:A}B(x),\ w : \Pi_{x:A}\; \Id_{B(x)}(u \cdot x,v \cdot x)\ \types\ C(u,v,w)\ \type \\ 
\Gamma,\ f : (x \tightcolon A) B(x)\ \types\ d(f) : C (\lambda f, \lambda f, \lambda (r \circ f)) \\
\Gamma\ \types\ k, k' : \Pi_{x:A} B(x) \qquad \Gamma\ \types\ l : \Pi_{x:A}\; \Id_{B(x)}(k \tightcdot x, k' \cdot x) }
{ \Gamma\ \types\ \Lterm(C,d,k,k',l) : C(k,k',l) } \]
and its associated computation rule $\PiIdcomp$, concluding:
\[ \Lterm(C,d, \lambda h, \lambda h, \lambda ( r \circ h)) = d(h) : C( \lambda h, \lambda h, \lambda (r \circ h)).\]

(Recall that $(x \tightcolon A)B(x)$ and $[x \tightcolon A] b(x)$ denote type- and term-abstraction in the metalanguage, while $u \cdot x$ denotes application.)

Correspondingly, a version of $\Jbar$ may be stated in second-order language as:
\[ \inferrule*[right={$\Jbarrule$}]{
  \Gamma,\ \underline{k}, \underline{k}' : (x \tightcolon A) B(x),\ \underline{l} : (x \tightcolon A) \Id_{B(x)}(\underline{k}x,\underline{k}'x)\ \types\ \underline{C}(\underline{k},\underline{k}',\underline{l})\ \type \\ 
  \Gamma,\ \underline{f} : (x \tightcolon A) B(x)\ \types\ \underline{d}(\underline{f}) : \underline{C} ( \underline{f}, \underline{f}, r \circ \underline{f}) \\
\Gamma\ \types\ \underline{k}, \underline{k}' : (x \tightcolon A) B(x) \qquad \Gamma\ \types\ \underline{l} : (x \tightcolon A) \Id_{B(x)}(\underline{k} x,\underline{k}' x) }
{ \Gamma \types \Jbarterm(\underline{C},\underline{d},\underline{k},\underline{k}',\underline{l}) : \underline{C}(\underline{k},\underline{k}',\underline{l}) } \]
and the corresponding computation rule concludes that
\[ \Jbarterm(C,d,k,k,r \circ k) = d(k) : C(k,k',l) . \]

(This is slightly stronger than the original, external formulation of $\Jbar$, since this rule implies stability in the ambient context $\Gamma$.) 

We can now define the eliminator $\Jbarterm$ in terms of $\Lterm$ by:
\[\Jbarterm(\underline{C},\underline{d},\underline{k},\underline{k}',\underline{l})\ :=\  \Lterm(\, [k,k',l]\,\underline{C}([x]k \tightcdot x,\,[x] k' \tightcdot x,\,[x] l \tightcdot x) ,\ \underline{d},\ \lambda \underline{k},\ \lambda \underline{k}',\ \lambda \underline{l} ).\]
It is routine to verify that under the hypotheses of the $\Jbar$ rule, this typechecks, and satisfies the required computational behaviour.

We are not quite done yet: since we used second-order reasoning, this gives us contractibility not between a theory $\T$ and an extension $\T[a'(\x) :\propeq a(\x)]$, but between $\T_\LF$ and its extension by terms $a' : [\x]A$, $l : [\x]\Id(a'(\x),a(\x))$ (briefly, $\T_\LF[a',l]$).  But given any type to lift from $\T$ to $\T[a'(\x) :\propeq a(\x)]$, consider the diagram
\[\bfig
\node Tty(-700,400)[\bullet]
\node Ttm(-700,0)[\bullet]
\node Ta(0,400)[{\T[a'(\x) :\propeq a(\x)]}]
\node T(0,0)[\T]
\node TaLF(1080,400)[{\T[a'(\x) :\propeq a(\x)]}_\LF]
\node TLFa(2000,400)[{\T_\LF[a',l]}]
\node TLF(2000,0)[\T_\LF]
\arrow[Tty`Ta;]
\arrow/@{-|>}/[Ta`TaLF;]
\arrow|m|[TaLF`TLFa;\iso]
\arrow/@{ >->}/[Tty`Ttm;i^\tm_n]
\arrow[Ta`T;]
\arrow/@{-|>}/[TLFa`TLF;]
\arrow[Ttm`T;]
\arrow/@{-|>}/[T`TLF;]
\arrow/@{.>}/[Tty`Ta;]
\efig\]
The contractibility of the maps $\T[a'(\x) :\propeq a(\x)] \to {\T[a'(\x) :\propeq a(\x)]}_\LF$ and $\T_\LF[a',l] \to \T_\LF$ lets us lift to a term in $\T[a'(\x) :\propeq a(\x)]$ which commutes correctly down to $\T_\LF$; but now by faithfulness of $\T \to \T_\LF$, it must in fact commute correctly already into $\T$.
\end{proof}

(It is tempting to wonder if the can be reversed; however, this is at least not obviously possible.  The obvious candidate for defining $\Lterm$ in terms of $\Jbarterm$,
\[\Lterm(C,d,k,k',l)\ :=\ \Jbarterm(\, [\underline{k},\underline{k}',\underline{l}]\, C( \lambda\underline{k},\lambda \underline{k}',\lambda\underline{l}),\ d,\ [x]\,k \tightcdot x,\ [x]\,k' \tightcdot x,\ [x]\,l \tightcdot x),\] 
does indeed typecheck successfully; but the desired computation rule only holds up to propositional equality, not definitional.) \\

Thus in theories with reasonably strong functional extensionality principles, $\Jbar$ holds, and holds robustly: it is derivable, so will continue to hold under strengthenings of the system.  However, it can fail as we weaken the system:

\begin{proposition} \label{prop:jbar-implies-ext}
For any set of constructors $\stuff$ including $\Pi$-types, $\Jbar$ implies a weak form of functional extensionality: if $x:A \types k(x),k'(x) : B$ and $x : A \types l(x):\Id(k(x),k'(x))$, then there is some term $\hat{l}$ for which $\types \hat{l} : \Id ( \lambda x.\,k(x),\, \lambda x.\, k'(x))$.
\end{proposition}

\begin{proof}
$\Jbar$ tells us that the map $\T_\stuff[k(x),k'(x),l(x)] \epi \T_\stuff[k(x)]$ is term-contractible; applying this to the type $\Id ( \lambda x.\,k(x),\, \lambda x.\, k'(x))$ upstairs and the term $r(\lambda x.\, k(x))$ downstairs yields a term as desired.
\end{proof}

\begin{corollary} \label{prop:jbar-fails}
$\Jbar$ fails for $(\Id,\Pi,\eta)$ and $(\Id,\Pi)$. 
\end{corollary}

\begin{proof}
The well-known \todo{[Citation?]} failures of $\extrule$ in these systems are also failures of the conclusion of Proposition \ref{prop:jbar-implies-ext}.
\end{proof}

However, these failures involve essential use of $\Pi$-types.  

\begin{conjecture}
$\Jbar$ holds for $(\Id)$.
\end{conjecture}

Proposition \ref{prop:jbar-fails} shows that if the conjecture is true, then $\Jbar$ is not stable under extensions of the constructor sets, so can't hold for $(\Id)$ as robustly as it does for $(\Id,\Pi,\Piextapp)$: it may be \emph{admissible} for the type theory with just $\Id$-types, but it cannot be \emph{derivable}. \\

\begin{para}[Variant forms of $\Jbar$]
In \ref{para:id-variants}, we considered alternatives to the standard $\Id$-$\elim$ rules.  Several of these correspond to analogous variants of $\Jbar$.  

Most straightforwardly, $\Jbar$ as given here is most akin to the one-ended form of $\Id$-$\elim$; analogously, one can also consider a two-ended form of $\Jbar$, in which $a(\x)$ as well as $a'(\x)$ is freely adjoined.  Indeed, the applications of $\Jbar$ we use later are all of this form; but using the one-ended form somewhat simplifies the presentation of the results of this section. 

One could also consider a principle one might call $\Kbar$, along the lines of Streicher's $\Kterm$, giving contractibility between theories $\T[a(\x)]$ and $\T[a(\x);\,l(\x) \tightcolon \Id(a(\x),a(\x))]$.  Like $\Kterm$, this of course collapses (at least up to propositional equality) all the higher-dimensional structure.

Even stronger (or at least possibly so)\todo{is there a known result connecting $\Kterm$ and the prop.\ conseqs.\ of refl?  check Streicher Habth thoro'ly}, one could consider a similar analogue of the reflection rule, asserting that for any (pre-existing) terms $a(\x)$, $a'(\x)$, $l(\x)$ of a theory $\T$, the map $\T \to \T[a'(\x) = a(\x),\,l(\x) = r(a(\x))]$ is term-contractible; this simply adds, by fiat, all the propositional consequences of $\refl$.
\end{para}

\begin{para} \label{para:j-and-k-homotopically}
This is perhaps the place to mention a homotopy-theoretic take on the difference between $\Jterm$ and $\Kterm$ (or between $\Jbar$ and $\Kbar$), and how $\Kterm$ trivialises the higher-categorical structure.  In terms of the homotopy theory given by the universal extensions, $\Jbar$ asserts roughly that the inclusion of one endpoint into a line segment is a weak equivalence (and moreover is preserved by certain pushouts along cofibrations).  This is homotopically essential, and powerful.  $\Kbar$ forces the inclusion of the basepoint into a \emph{loop} to be a weak equivalence.  It is then clear that the structures represented by such loops must be homotopically trivial, and more usefully, the topological intuition which makes this clear can be pulled back through the dictionary to recover the usual type-theoretic arguments.
\end{para}

% \begin{para} \todo{[Discuss the relationship of $\Jbar$ to \emph{equivalence vs.\ interderivability of axioms}, which is probably the best argument for why even non-homotopically-inclined type theorists should care about it?]} \end{para}






 


















\section{Contractible operads; weak \pdfomega-categories from \texorpdfstring{$\DTT$}{DTT}} \label{sec:contractibility}

% \comment{Include:  General contractibility of operads.  Give in terms of pylon diagrams.  Prune/contract pasting diagrams.  Recall L09/GvdB ``if whole glob obj is nice, then co-points of pds are ctrble''.  Refine that!  Reduce to more 1-d filling problem.}

% \comment{In light of this, give various conditions for classifying weak $\omega$-category to exist: $\Jbar$ plus normalisation plus $(-)^\cxt$, etc.}

 In this section, we investigate various conditions under which we can map some contractible operad into $\End(\globes)$, and hence give a weak $\omega$-category structure.  In summary, we obtain a weak $\omega$-structure:
\begin{enumerate}
\item on $\cl_\omega$, conjecturally (depending on $\Jbar$), for all theories with $\Id$-types;
\item on $\cl_\omega$, unconditionally, for theories with $\Id$- and $\Pi$-types and the extensionality rules $\Piext$ and $\Piextapp$; and
\item on $\clpi_\omega$, for theories with $\Id$- and $\Pi$-types and the $\Pi$-$\eta$ rule.
\end{enumerate}

\begin{figure}[htbp]
\[\bfig
%%%%%%%%%%%%%%%%%%%
% left hand pylon %
%%%%%%%%%%%%%%%%%%%
\node gn(250,0)[\globefig{n}]
\node gn1l(0,-250)[\globefig{n-1}]
\node gn1r(500,-400)[\globefig{n-1}]
\node gn2l(0,-650)[\globefig{n-2}]
\node fakegn2l(450,-650)[]
\node gn2r(500,-800)[\globefig{n-2}]
\node g1l(0,-1150)[\globefig{1}]
\node g1r(500,-1300)[\globefig{1}]
\node g0l(0,-1550)[\globefig{0}]
\node g0r(500,-1700)[\globefig{0}]
\arrow[gn1l`gn;]
\arrow[gn1r`gn;]
\arrow[gn2l`gn1l;]
\arrow[gn2r`gn1l;]
\arrow[gn2l`gn1r;]
\arrow[gn2r`gn1r;]
\arrow/@{}|<>(0.58)\vdots/[g1l`gn2l;]
\arrow/@{}|<>(0.58)\vdots/[g1r`gn2r;]
\arrow[g0l`g1l;]
\arrow[g0r`g1l;]
\arrow[g0l`g1r;]
\arrow[g0r`g1r;]
%%%%%%%%%%%%%%%%%%%%
% right hand pylon %
%%%%%%%%%%%%%%%%%%%%
\node Tpi(1750,0)[{\T_\stuff[\widehat{\pi}]}]
\node Tspi(1500,-250)[{\T_\stuff[\widehat{s\pi}]}]
\node Ttpi(2000,-400)[{\T_\stuff[\widehat{t\pi}]}]
\node Ts2pi(1500,-650)[{\T_\stuff[\widehat{s^2\pi}]}]
\node Tt2pi(2000,-800)[{\T_\stuff[\widehat{t^2\pi}]}]
\node Ts1pi(1500,-1150)[{\T_\stuff[\widehat{s_1\pi}]}]
\node Tt1pi(2000,-1300)[{\T_\stuff[\widehat{t_1\pi}]}]
\node Ts0pi(1500,-1550)[{\T_\stuff[\widehat{s_0\pi}]}]
\node Tt0pi(2000,-1700)[{\T_\stuff[\widehat{t_0\pi}]}]
\arrow[Tspi`Tpi;]
\arrow[Ttpi`Tpi;]
\arrow/@{>}|!{(500,-400);(2000,-400)}\hole/[Ts2pi`Tspi;]
\arrow/@{>}|!{(500,-400);(2000,-400)}\hole/[Tt2pi`Tspi;]
\arrow[Ts2pi`Ttpi;]
\arrow[Tt2pi`Ttpi;]
\arrow/@{}|<>(0.58)\vdots/[Ts1pi`Ts2pi;]
\arrow/@{}|<>(0.58)\vdots/[Tt1pi`Tt2pi;]
\arrow/@{>}|!{(500,-1300);(2000,-1300)}\hole/[Ts0pi`Ts1pi;]
\arrow/@{>}|!{(500,-1300);(2000,-1300)}\hole/[Tt0pi`Ts1pi;]
\arrow[Ts0pi`Tt1pi;]
\arrow[Tt0pi`Tt1pi;]
%%%%%%%%%%%%%%%%%%%%
% connecting wires %
%%%%%%%%%%%%%%%%%%%%
\arrow/@{.}/[gn`Tpi;H]
\arrow/@{>}|!{(250,0);(500,-400)}\hole/[gn1l`Tspi;F_{n-1}]
\arrow[gn1r`Ttpi;G_{n-1}]
\arrow/@{>}|<>(.19)\hole|!{(500,-800);(500,-400)}\hole/[gn2l`Ts2pi;F_{n-2}]
\arrow[gn2r`Tt2pi;G_{n-2}]
\arrow[g1l`Ts1pi;F_1]
\arrow[g1r`Tt1pi;G_1]
\arrow/@{>}|<>(.21)\hole|!{(500,-1700);(500,-1300)}\hole/[g0l`Ts0pi;F_0]
\arrow[g0r`Tt0pi;G_0]
\efig\]
\caption{Contractibility in an endomorphism operad \label{fig:contractibility-pylons}} 
\end{figure}

\subsection*{\texorpdfstring{$\End(\globes)$}{End(G.)} in theories with \pdfId-types}

\renewcommand{\stuff}{\Id}
\begin{theorem} \label{thm:ctrble-operad-for-id} If $\Jbar$ holds for $\Id$, then $\End(\globes^\Id)$ is contractible.
\end{theorem}

\begin{proof}
As seen in the second proof of Theorem \ref{thm:p-is-contractible}, contractibility for this operad demands that given any pasting diagram $\pi \in T1(n)$, and $(F_0,G_0,\ldots G_{n-1})$ as in Fig.\ \ref{fig:contractibility-pylons}, we must construct $H$ to complete the map of spans; more concisely, we must complete the triangle
\[\xymatrix{ \del \globe[n] \ar[r]^{[F_i,G_i]} \ar@{ >->}[d] & \T_\stuff[\del \hat{\pi}]  \ar@{ >->}[r] & \T_\stuff[\hat{\pi}] \\ \globe[n] \ar@{.>}[urr] & }.\]

The cases $n= 0,1$ are dealt with by \ref{para:map-from-pcat} et seq.\ above: in dimension $0$, contractibility is satisfied just by the existence of the 0-dimensional identity operation; while in dimension $1$, it demands the existence of composition operations of each arity, which are supplied by the map $\psi \colon P_{\Cat} \to \tr^1 \End(\globes)$.

On the other hand, when $n > 0$, it is immediate from the axiomatisations given that the map $\del \globe[n] \to/ >->/ \globe[n]$ is a term-extension.  Also, according to the pruning procedure described in \ref{para:pruning-pds} above, we can obtain $\T_\stuff[\hat{\pi}]$ as an extension of $\T_\stuff[\widehat{s_1\pi}]$ by propositional copies: it is a composition of maps $\T_\stuff [\rho^-] \mono \T_\stuff[\rho]$, each of which is an extension by propositional copies by the pushout squares of \ref{para:pruning-realisation}.  So \emph{provided $\Jbar$ holds for $\DTT_\stuff$}, the retraction
\[\T_\stuff[\hat{\pi}] \epi \T_\stuff[\widehat{s_1\pi}]\]
(interpreting all identity cells as reflexivity terms) is term-contractible.

Thus to complete the triangle above, it is sufficient to complete the square
\[\xymatrix{ \del \globe[n] \ar[r]^{[F_i,G_i]} \ar@{ >->}[d] & \T_\stuff[\hat{\pi}] \ar@{-|>}[d] \\ \globe[n] \ar@{.>}[r] & \T_\stuff[\widehat{s_1\pi}]},\]
i.e.\ to complete a triangle of the form
\[\xymatrix{ \del \globe[n] \ar[dr] \ar@{ >->}[d] & \\ \globe[n] \ar@{.>}[r] & \T_\stuff[\widehat{s_1\pi}]}.\]

But now $s_1\pi$ is just some $\pathpd_l$, so as in \ref{para:map-from-cat}, \ref{para:canonicity-in-Tpath} we have an explicit axiomatisation of $\T_\Id[\widehat{s_1 \pi}]$, and we know that this theory enjoys canonicity.  So in trying to extend $[F_i,G_i]$ along $ \del \globe[n] \mono \globe[n]$, we have interpreted $i$-$\sourcerule$ and $i$-$\targetrule$ in $\T_\stuff[\widehat{s_1\pi}]$, for $i < n$, and wish to interpret $n$-$\cellrule$; i.e.\ we wish to prove a propositional equality between the interpretations of $s_{n-1}(x)$ and $t_{n-1}(x)$.   But by canonicity, and the simplicity of our set of constructors, any two terms of the same type in $\T_\stuff[\widehat{s_1\pi}]$ in context $x\tightcolon A_0$ are \emph{definitionally} equal; so interpreting $c_n$ as a reflexivity term, we are done.  (Specifically, $s_1$, $t_1$ must both be interpreted as the obvious composite of basic constructors described in \ref{para:map-from-cat}, and for $i > 1$, $s_i$ and $t_i$ must be interpreted as the reflexivity term over $s_{i-1}$, $t_{i-1}$.)
\end{proof}

\subsection*{\texorpdfstring{$\End(\globes)$}{End(G.)} in theories with \texorpdfstring{$\Piextapp$}{Π-ext-app}}

\renewcommand{\stuff}{\Piextapp}  % augh! doing it this way was a terrible idea!
\begin{para} By turning our attention to theories with not only $\Id$-types but also $\Pi$-types, $\Piext$, and $\Piextapp$, we ensure that $\Jbar$ holds unconditionally.  However, this comes at the possible cost of normalisation and canonicity.  Thus, in trying to repeat the argument above to show that $\End(\globes)$ is contractible, we fall at the last hurdle: we do not know that $[F_i,G_i]$ gives the ``correct'' map $\del \globe[n] \to \T_\stuff[\widehat{\pathpd_l}]$.

To remedy this, we simply restrict to the sub-operad of operations for which this holds.  This is just an elaboration of the tactic used in \cite{garner-van-den-berg}, of restricting to the operad of point-preserving operations, as discussed in \ref{remarks:fundamental}. 
\end{para}


\begin{definition} \label{def:ref-1-glob} For $\E$ any category with pullbacks, define a monoidal category $\RefnGlob{1}{\E}$ as follows:
\end{definition}

\begin{wrapfigure}[15]{r}{0.15\textwidth}
\vskip -1.5em
$\bfig
\node An(0,0)[A_n]
\node An1(0,-400)[A_{n-1}]
\node A2(0,-900)[A_2]
\node A1(0,-1300)[A_1]
\node A0(0,-1700)[A_0]
\arrow|m|/@<0ex>/[An`An1;s]
\arrow|m|/@<1ex>/[An`An1;t]
\arrow/@{}|<>(0.58)\vdots/[A2`An1;]
\arrow|m|/@<0ex>/[A2`A1;s]
\arrow|m|/@<1ex>/[A2`A1;t]
\arrow|m|/@<-0.5ex>/[A1`A0;s]
\arrow|m|/@<0.5ex>/[A1`A0;t]
\arrow|m|/@/^0.5em//[A1`A2;r]
\arrow|m|/@/^1.35em//[A1`An1;r]
\arrow|m|/@/^2.5em//[A1`An;r]
\efig$ %\caption{\label{fig:modspan} \textcolor{white}{longword}}
\end{wrapfigure}

Objects in dimension $n$ are globular objects $\A$ of $\E$, together with \emph{reflexivity data from dimension 1}: for $1 \leq i \leq n$, a map $r_i \colon A_1 \to A_i$, such that $s_i r_{i+1} = t_i r_{i+1} = r_i$, and $r_1 = 1_{A_1}$.

A map between two of these is a map $(f_i,g_i,h)$ between their ``underlying'' spans, with $f_0 = g_0$, $f_1 = g_1$, and commuting with the reflexivity data in that $f_i r_i = g_i r_i = r_i f_1$, and $h r_n = r_n f_1$.

The monoidal globular structure of $\RefnGlob{1}{\E}$ is lifted from that of $\Spans[\E]$.  Any tensor product $\A \tensor_k \B$ in $\Spans[\E]$ of globular objects is again globular, and reflexivity data on the multiplicands lifts naturally to reflexivity data on the product; and similarly, the units over globular objects are globular and carry natural reflexivity data. \\

We thus have a monoidal globular category and faithful forgetful functor
\[\RefnGlob{1}{\E} \to \Spans[\E].\]

(Note that, as the definition of the maps hints, the globularity condition on objects in dimensions $>1$ is not actually required here, and it would arguably be more natural to omit it.  However, all spans occurring in the construction of endomorphism operads remain fully globular, so it makes no difference for present purposes, and it simplifies the specification of the reflexivity data.) \\

Instantiating this construction with $\E = \DTT^\op$, the globes $\globes$ lift (using their reflexivity maps) to a globular object in $\RefnGlob{1}{\DTT^\op}$.  We thus obtain a new endomorphism operad for them; since the forgetful functor is faithful, this is just a sub-operad of the old
\[\End_{\RefnGlob{1}{\DTT^\op}}(\globes) \mono \End_{\Spans[\DTT^\op]}(\globes)\]
consisting of operations as in Figure \ref{fig:endo-pylons}, satsifying the additional condition that whenever all the higher term-formers in $\T[\pi]$ are interpreted as reflexivity terms, then the interpretations of the term-formers of $\globes{n}$ also compute down to reflexivity terms.

\begin{para}From here we need to restrict still a little further before we have a contractible operad: we need to look at just those operations which do the correct thing in dimensions $\leq 1$.  Specifically, the map $\psi \colon P_\Cat \to \tr^1\End(\globes)$ is easily seen to factor through $\End_{\RefnGlob{1}{\DTT^\op}}(\globes)$; so let $Q_\Piextapp$ be the pullback
% \[\xymatrix{ P \ar[r] \ar[d] & \End_{ModSpans[\DTT^\op]}(\globes) \ar[d]^\eta \\ P_{\strwCat} = I P_\Cat \ar[r]^{I \psi} & I \tr^1 \End_{ModSpans[\DTT^\op]}(\globes)}\]
\[\bfig 
\node Q(0,400)[Q_\Piextapp]
\node End(1400,400)[\End_{\RefnGlob{1}{\DTT^\op}}(\globes)]
\node Pstr(0,0)[P_{\strwCat} = I P_\Cat]
\node ItrEnd(1400,0)[I \tr^1 \End_{\RefnGlob{1}{\DTT^\op}}(\globes)]
\arrow/@{ >->}/[Q`End;]
\arrow[Q`Pstr;]
\arrow[End`ItrEnd;\eta]
\arrow/@{ >->}/[Pstr`ItrEnd;I \psi]
\place(100,300)[\pb]
\efig\]
(where $I \colon \nOpd[1] \to \nOpd[\omega]$ is the ``indiscrete $\omega$-operad'' functor, right adjoint to $\tr^1$ as described in \ref{para:normalised-core}); then $Q_\Piextapp$ consists precisely of those operations of $\End_{\RefnGlob{1}{\DTT^\op}}(\globes)$ whose $\leq 1$-dimensional parts lie in the image of $\psi$.  We are now set up for:
\end{para}

\begin{theorem}\label{thm:ctrble-operad-for-piidelim}The suboperad $Q_\Piextapp \mono \End(\globes)$ is contractible.
\end{theorem}

\begin{proof}Contractibility in dimensions $\leq 1$ holds by fiat: in these dimensions, $Q_\Piextapp$ is isomorphic to the terminal operad.

For higher dimensions, note that operations in this new operad are just as in the old, except that additionally the maps involved must commute with the reflexivity data.  So contractibility now demands that for $\pi \in \pd_n$, and suitable $(F_i,G_i)_{i < n}$, we must produce a map $H : \globe[n] \to \T_\stuff[\widehat{\pi}]$ making both squares in the following diagram commute:\todo{cosmetics!}
\[\xymatrix{ 
  \del \globe[n] \ar[r]^{[F_i,G_i]} \ar@{ >->}[d] 
  & \T_\stuff[\del \hat{\pi}]  \ar@{ >->}[d] 
\\
  \globe[n] \ar@{.>}[r]  \ar@{-|>}[d]
  & \T_\stuff[\hat{\pi}] \ar@{-|>}[d]
\\ 
  \globe[1] \ar[r]_{F_1 = G_1}
  & \T_\stuff[\widehat{s_1 \pi}]
}.\]

But the overall rectangle commutes, so (rearranging it as a square) the desired filler follows by $\Jbar$.
\end{proof}

\renewcommand{\stuff}{\Phi}  % augh! doing it this way was a terrible idea!

\subsection*{\texorpdfstring{$\End(\piglobes)$}{End(ΠG.)} in theories with \pdfId, \pdfPi, \pdfPi-\pdfeta}

Turning our attention to $\piglobes$, and considering theories with the rules $(\Id,\Pi,\Pi\mbox{-}\eta)$, we are now well set up to construct a contractible sub-operad $Q_\Pi$ of $\End(\piglobes)$.  Specifically, take $Q_\Pi$ to be the normalised core of $\End(\piglobes)$---that is, all those operations whose $0$-dimensional source and target are the operad unit $1_{\piglobe[0]}$.  Since we have canonicity, we do not need to restrict further as we did in the construction of $Q_\Piextapp$.

\begin{theorem} \label{thm:ctrble-operad-for-pi}
The operad $Q_\Pi$ is contractible.
\end{theorem}

\begin{proof}
The proof of Theorem \ref{thm:ctrble-operad-for-id} goes through almost verbatim.  The only difference is that the type-contractibility of the maps into which we factor $\T_\stuff[\widehat{\pi}]^\Pi \epi \T_\stuff[\widehat{s_1 \pi}]^\Pi$ does not depend on $\Jbar$, instead following just from Example \ref{ex:elim-gives-contraction}. 
\end{proof}

\subsection*{Classifying weak \pdfomega-categories}
% TODO: should be \\\texorpdfstring here

\begin{para} Theorems \ref{thm:ctrble-operad-for-id}, \ref{thm:ctrble-operad-for-piidelim}, and \ref{thm:ctrble-operad-for-pi} give  three situations in which there is a map from some contractible operad $Q$ into $\End(\globes)$ (or $\End(\piglobes)$).  In each case, this induces a map $L \to Q \to \End(\maybepiglobes)$, and hence a functor (``restriction of scalars'') $\Alg{\End(\maybepiglobes)} \to \Alg{L} = \wkwCat$.  We thus have:
\end{para}

\begin{theorem} \label{thm:main-thm-classifying} $\ $
\begin{enumerate}
\item There is a functor $\cl_\omega \colon \DTT_{\Piextapp} \to \wkwCat$, giving the ``classifying weak $\omega$-category'' of any theory with at least $\Id$-types, $\Pi$-types, and the $\Piext$, $\Piextapp$ rules.
\item If $\Jbar$ holds for $\Id$, then we moreover have $\cl_\omega \colon \DTT_{\Id} \to \wkwCat$, giving the classifying weak $\omega$-category for any theory with at least $\Id$-types.
\item There is a functor $\clpi_\omega \colon \DTT_{\Id,\Pi} \to \wkwCat$ giving a variant of the classifying weak $\omega$-category, for any theory with at least $\Pi$-types, $\Id$-types, and the rule $\Pi$-$\eta$.
\end{enumerate}
\end{theorem}

This statement, while pleasing, has a few loose ends which deserve to be tied up.


\begin{para}Firstly, what can be said about non-contextual CwA's?  This is an important question for applications, since CwA's arising semantically are rarely contextual, and we would like to get higher categories not just from syntactically presented theories, but also from models.

Given a general CwA $\C$, we can take $\cl_\omega(\C \slice \diamond)$, the classifying weak $\omega$-category of its contextual core.  (Since $\slice \diamond$ is a coreflection, we could equivalently use $\cl_\omega^-$.)  Thinking of general CwA's as semantic and contextual ones as syntactically presented, this is just taking the classifying weak $\omega$-category of the internal language of $\C$.

Fortunately, we have not lost much.  Most semantic CwA's, though not contextual, are \emph{accessible}, and hence equivalent to their contextual core, so in these cases $\cl_\omega(\C \slice \diamond)$ should remain at least weakly equivalent to any other reasonable definition of the classifying weak $\omega$-category of $\C$.

On the other hand, the loss of inaccessible objects seems inevitable: there is no way to define ``identity objects'' over an arbitrary object, if one cannot express it as a context of types, and without this, it is not clear how one would expect the object to participate as a 0-cell in the classifying weak $\omega$-category.
\end{para}


\begin{para}Secondly, there is an obvious abuse of notation: if $\Jbar$ holds for $\Id$, then we are overloading $\cl_\omega$ not only with different codomains, a mild and common sin, but also with different domains, a potentially worse one.  Given a theory $\T$ with at least the $\PiIdelim$ rule, we could compute $\cl_\omega(\T)$ as such a theory, or we could treat it as a theory over $\Id$-, and compute $\cl_\omega(\T)$ from there.  Will these agree?  In other words, does $\cl_\omega$ commute with the forgetful functor $U \colon \DTT_\Piextapp \to \DTT_\Id$, as in the following diagram?
\[\bfig
\node DTTPi(-200,400)[\DTT_\Piextapp]
\node DTTId(-200,0)[\DTT_\Id]
\node GPiAlg(800,400)[\Alg{\End(\globes^\Piextapp)}]
\node QAlg(1900,400)[\Alg{Q_\Piextapp}]
\node GIdAlg(800,0)[\Alg{\End(\globes^\Id)}] % (1200,0) if curved map below included
\node wkwCat(2400,0)[\wkwCat]
\node GSets(1100,-400)[\GSets]
\arrow|l|/@/^0.5em//[DTTId`DTTPi;F]
\arrow|r|/@/^0.5em//[DTTPi`DTTId;U]
\arrow[DTTPi`GPiAlg;]
\arrow[DTTId`GIdAlg;]
\arrow[GPiAlg`GIdAlg;]
\arrow[GPiAlg`QAlg;]
\arrow[QAlg`wkwCat;]
\arrow[GIdAlg`wkwCat;]
\arrow[DTTId`GSets;]
% \arrow/@/_0.5em//[GPiAlg`GSets;]
\arrow[GIdAlg`GSets;]
\arrow[wkwCat`GSets;]
\place(1400,200)[(?)]
\place(-200,190)[\dashv]
\efig\]

Most parts of this diagram are easily seen to commute up to natural isomorphism.  The essential point is that the globes $\globes^\Piextapp$ are just the image of $\globes^\Id$ under the left adjoint $F \colon \DTT_\Id \to \DTT_\Piextapp$, since their axiomatisations involve only $\Id$-types; and hence as functors into globular sets, or even into $\End(\globes^\Id)$-algebras, we have $\DTT_\Piextapp(\globes^\Piextapp, \T) \iso \DTT_\Id(\globes^\Id, U(\T))$.

This leaves, as the dubious part, the square marked by (?).  This comes down to the question of whether the corresponding square of operad maps commutes
\[\bfig
\node L(0,500)[L]
\node EndGId(1200,350)[\End(\globes^\Id)]
\node Q(400,0)[Q_\Piextapp]
\node EndGPi(1200,0)[\End(\globes^\Piextapp)]
\arrow[L`EndGId;]
\arrow[EndGId`EndGPi;]
\arrow[L`Q;]
\arrow[Q`EndGPi;]
\place(700,225)[(?)]
\efig\]
and now the subtlety emerges: the maps out of $L$ are defined in terms of the specific contractions used on $Q_\Piextapp$, and these in turn depend on how precisely we have implemented $\Jbar$.

What we can at least see is that (by the normalisation results used in \ref{thm:ctrble-operad-for-id}) $\End(\globes^\Id) \to \End(\globes^\Piextapp)$ factors through $Q_\Piextapp$, so it comes down to commutativity of the triangle
\[\bfig
\node L(0,200)[L]
\node EndGId(600,400)[\End(\globes^\Id)]
\node Q(600,0)[Q_\Piextapp]
\arrow[L`EndGId;]
\arrow[EndGId`Q;]
\arrow[L`Q;]
\place(380,200)[(?)]
\efig\]

This will certainly hold if $\End(\globes^\Id) \to Q_\Piextapp$ is a map of operads-with-contraction, i.e.\ iff it preserves the contraction; and it is fairly routine (though rather notationally fiddly) to show that if the forgetful functor $U \colon \DTT_\Piextapp \to \DTT_\Id$ ``preserves the implementation of $\Jbar$'' in an appropriate sense, then this will be the case.  

% \todo{[in fact, I think it's impossible; check this out if time allows!]}
However, it seems unlikely to the present author that the implementation of $\Jbar$ given above for theories with $\Piextapp$ could be preserved by $U$.  This defect can (as often in problems with contractions) be finessed by some ad hoc modification of the contractions on the operads involved; but essentially, this is a problem that should be resolved not by strict-higher-categorical fiddling, but by the theory of weak higher-categorical equivalence, under which the squares marked (?) would commute \emph{up to weak equivalence}.  In lieu of the development of this theory, then, we leave a resolution of this problem aside for now.

Such tools should also allow one to address the question of when $\clpi_\omega$ may be equivalent to $\cl_\omega$.
\end{para}

\begin{para}Finally, there is an abuse of terminology: what, if anything, does the classifying weak $\omega$-category classify?

As given at present, in the form of the functors ${}^{(\Pi)} \cl_\omega \colon \DTT_\stuff \to \wkwCat$ above, it cannot classify anything: that is, it cannot have a right adjoint, since it does not preserve the initial object, nor a left, since it does not preserve the terminal object.  (The initial theory in $\DTT_\stuff$ is $\T_\stuff$, whose $\cl_\omega$ is certainly non-empty, containing the empty context $\diamond$ as a 0-cell, and so is not initial in $\wkwCat$.  Similarly, the terminal theory in each $\DTT_\stuff$ has one context of each length $l \in \N$, and so its $\cl_\omega$ will have $\N$-many 0-cells.)

However, this is not surprising: in the passage from type theories to weak $\omega$-categories, we have forgotten much structure (and co-structure).  One of the next important steps in the current program should be the axiomatisation of higher-categorical structure corresponding to the structure on the type theories, in such a way that the classifying $\omega$-categories of theories carry such structure, and (hopefully) do indeed appropriately classify some kind of models in these structured higher categories.

For the 2-truncated case, this is well-worked-out in \cite{garner:2-d-models}.  However, in higher dimensions, the understanding of appropriate ``weak logical structure'' is at a very early stage of development; so this too is a story for another day.
\end{para}
% 
% \subsection*{CwA structures on $\DTT$ etc.} \ref{sec:fam-strux-on-DTT}.
% 
% \comment{This section is an inessential extra: if time allows and inspiration strikes (or if quantity demands) then I'll update + expand it, otherwise I'll delete it.}
% 
% An alternate perspective on $\Jbar$, shows that it can be seen not just as analogous to the $\Id$-elim rule, but actually as instance of it for a certain attributes-structure:
% 
% There are various important CwA-structures on categories of CwA's. In particular: there is a canonical CwA structure on $\CwA_\diamond^\op$, given by $\Ty^\mathrm{canon}_{\CwA_\diamond^\op}(\C) := \Ty_\C(\diamond)$, and $\C.A := \C/\!/A$.  The universal properties of slices (Proposition \ref{prop:slicing}), with general facts about free constructions, ensure that the requisite squares [diagram] are pullbacks.  (This is in some sense a universal CwA: certainly every small CwA may be obtained by pullback from it, a more precise statement can probably be formulated.)
% 
% This extends to a canonical CwA-structure with $\Id$-types on $(\CwA^\Id_\diamond)^\op$, a CwA-structure with $\Id$- and $\Pi$-types with $\eta$-rule on $(\CwA^{\Id,\Pi,\eta}_\diamond)^\op$, and so on.
% 
% However, we can bump up these structures a little further, to include certain ``formal $\Pi$-types'' (independently of what $\Pi$-types may already be present in the theories).  That is, we define $\Ty^\mathrm{canon + Pi}(\C) := \sum_{\Gamma \in \C} \Ty_\C(\Gamma)$; so a type over $\C$, in this attributes structure, is a type $A$ in some context $\Gamma$ of $\C$, to be thought of as the formal dependent product $\prod_\Gamma A$.
% 
% Context extension is by adjoining \emph{open} terms.
% 
% $\Jbar$ asserts that \emph{open} $\Id$-types in contexts are indeed $\Id$-types in this attributes structure.  (But danger, Will Robinson, danger: $\Jbar$ doesn't assert, and afaics doesn't imply, the stability/coherence conditions required for ``this attributes structure has $\Id$-types''.)
% 
% \subsection*{A model structure on $\DTT$?} \ref{sec:model-strux}
% 
% Another optional bonus section.
