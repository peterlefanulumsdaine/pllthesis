\documentclass{amsart}

\usepackage{color}
\usepackage{ifpdf}
\usepackage{mathpartir}
\usepackage{amssymb}
\usepackage{amsthm}
\usepackage{amsmath}
\usepackage[all]{xypic}
\usepackage{wrapfig}

\xyoption{2cell}
\xyoption{rotate}
%\xyoption{curve}
\UseTwocells
\input{diagxy}

% \usepackage{makeindex}

\include{thesis-style}
\include{thesis-macros}

\newcommand{\CompCat}{\mathbf{CompCat}}

\newcommand{\arr}{\mathrm{arr}}
\newcommand{\ext}{\mathrm{ext}}
\newcommand{\Jbar}{\overline{J}}
\newcommand{\tree}{\mathrm{tree}}
\newcommand{\tr}{\mathrm{tr}}
\newcommand{\stuff}{{\Phi}}
% \makeindex

%%
%% PDFJUNK
%% Can add /CreationDate, /Creator, /Subject, /Keywords
%%
\ifpdf
\pdfinfo{
  /Author (Peter LeFanu Lumsdaine) 
  /Title (TODO: put thesis title here when decided!)
}
\fi
%%
%% BEGIN DOCUMENT:
%\onehalfspacing
\begin{document}



%% TITLE INFORMATION

\title{The classifying weak $\omega$-category of a type theory}

\author[P. LeF. Lumsdaine]{Peter LeFanu Lumsdaine}

\maketitle
\tableofcontents

\section*{General notes on these notes}

Note on notation: all fibrations of categories are assumed cloven, but considered just as fibrations ($\Fib$), maps between them need not preserve the cleavings, whereas maps of cloven fibrations ($\ClovFib$) do.


\section{Type-theoretic background}

This should move to an earlier chapter, or possibly (in part?) an appendix, when I \texttt{amsbook} the whole thing up.  Essential points:  set up $\DTT$, show it's essentially algebraic, give the adjunction which gets us universal properties of axiomatisations, give the normalisation results needed.


\subsection{Setting: a category of dependent algebraic type theories}

\begin{definition}A \emph{category with families}: $\C$, $\Ty$, comprehension$\ldots$  Variations: with $\diamond$; with $1$, with nothing, accessible, contextual.
\end{definition}

\begin{proposition}[\cite{hofmann:syntax-and-semantics}, \cite{pitts:categorical-logic}] \label{prop:cwf-equivalence} Equivalence: small contextual CwF's are \emph{equivalent} to type theories presented by a small set of purely algebraic axioms (i.e.\ dependent terms and types, and equality axioms between them), via adjunction.  Hence: universal property of CwF's presented by axioms (need this precisely stated to allow us to use normalisation results below).
\end{proposition}

This equivalence justifies working with \emph{presentation-agnostic} category of type theories $\DTT$: we will construct and work with objects of $\DTT$ (\emph{theories}) sometimes as syntactic presentations, sometimes as categories with families.  Given any construction either on syntactically presented theories or on contextual CwF's, we'll transfer it without comment to $\DTT$, and so forth.  In subsequent sections, we will work almost(?) entirely in terms of $\DTT$, but for the constructions of this section it will be convenient to work in $\CwF_\cxl$, for the sake of its connections to other categories of CwF's.

\begin{para} We'll use a few pieces of obvious terminology for working in CwF's.  For an object $\Gamma \in \C$, a \emph{dependent context} over $\Gamma$ is a sequence $A_1 \in \Ty(\Gamma)$, $A_2 \in \Ty(\Gamma.A_1)$, \ldots $A_l \in \Ty(\Gamma.A_1.\ldots.A_{l-1})$, for some $l \geq 0$.  (Write $\Cxt(\Gamma)$ for the set of these.)

For a type $A \in \Ty(\Gamma)$, a \emph{term of type $A$ in context $\Gamma$} is a section $a : \Gamma \to \Gamma.A$ of the dependent projection $\Gamma.A \to \Gamma$.  (Write $\Tm_\Gamma(A)$ for the set of these.)
\end{para}

\subsection{Theories with constructors}

Of course, we want categories not just of \emph{algebraic} dependent type theories, but of type theories with \emph{constructors}; in particular, $\Id$- and $\Pi$-types.  These too can be succinctly and profitably defined in terms of CwF's.  In particular:

\begin{definition} An \emph{elim-structure} $J$ on a map $i : \Gamma \to \Theta$ is a function assigning, to every type $C \in \Ty(\Theta)$ and every term $d : \Gamma \to \Gamma.i^*C$ of type $i^*C$ (equivalently, every map $\hat{d} : \Gamma \to \Theta.C$ over $\Theta$) a term $J_{C,d} : \Theta \to \Theta.C$ of type $C$

An \emph{absolute (Frobenius?) elim-structure} on $i : \Gamma \to \Theta$ is an elim-structure $J_\Delta$ on $i.\Delta$ for each $\Delta \in \Cxt(\Theta)$.
\end{definition}

(Compare the last refinement described in Example \ref{ex:left-maps-from-right} above, with the basic dependent projections $\Theta.A \to \Theta$ as the generating $\R$-maps (see next subsection).)

This axiomatises the structure provided by the elimination/computation rules for an inductive type with just a single introduction form $i$.  (It can be nicely generalised to deal with multiple introduction forms, but we will not need that.) In particular:

\begin{definition}
A \emph{CwF with $\Id$-types} is a CwF $\C$, together with:
\begin{itemize}
\item for each context $\Gamma \in \C$ and type $A \in \Ty(\Gamma)$, a type $\Id_A \in \Ty(\Gamma.A.A)$, and a morphism $r_A : \Gamma.A \to \Gamma.A.A.\Id_A$ over $\Delta_A : \Gamma.A \to \Gamma.A.A$ with an absolute elim-structure $J_A$,
\item all stable in $\Gamma$, in that for $f:\Gamma' \to \Gamma$ and $A \in \Ty(\Gamma)$, we have $(f.A.A)^*\Id_A = \Id_{f^*A} \in \Ty(\Gamma'.f^*A.f^*A)$, and so on.
\end{itemize}
\end{definition}

Write $\CwF^\Id$, $\CwF_\diamond^\Id$, etc.\ for the various categories of CwF's with $\Id$-types.  

\begin{proposition}[\cite{hofmann:syntax-and-semantics}, \cite{pitts:categorical-logic}] This structure really does correspond precisely to the $\Id$-type rules: the equivalence of Proposition \ref{prop:cwf-equivalence} lifts to an equivalence between $\CwF^\Id_\cxl$ and a category of syntactically presented theories with $\Id$-type rules plus algebraic axioms. 
\end{proposition}

Also: define $\Pi$-types, $\eta$-rules, and extensional equality on them. 

\begin{para}{Left and right maps in a CwF} \label{subsec:left-right-in-cwf}
The above presentation of $\Id$-types via elim-structures is based on ideas of Gambino and Garner (\cite{gambino-garner}) which will be very useful to us: that any CwF has an important class of left and right maps, which in the presence of $\Id$-types is moreover a wfs.

The right maps are just (maps isomorphic to) (compositions of basic) dependent projections.  The left maps are maps admitting an (or algebraically: with a chosen) elim-structure; following observations above, this gives exactly $\L = {}^\pitchfork \R$.  

(\cite{gambino-garner} moreover gives an alternative type-theoretic characterisation of each class of maps, and uses $\Id$-types to construct $\L,\R$ factorisations, but we will not need these.)
\end{para}


\subsection{Constructions on DTT's/CwF's}

There are several interesting and important ways to construct new type theories from old:

\begin{para} First, the \emph{dependent contexts monad} on $\CwF$ over $\Cat$, sending $\C = (\C,\Ty)$ to $\C^\Cxt := (\C,\Cxt)$.  So types of the new theory are just dependent contexts in the old theory; the base category is unchanged, and context extension is just by concatenation.  This can be seen as the monad for ``very strong, strictly associative $\Sigma$-types''.)  

Moreover, given $\Id$-types structure on $\C$, we can extend this to an $\Id$-types structure on $\C^\Cxt$: this is the ``identity contexts'' of \cite{streicher:habilitationsthesis} or \cite{gambino-garner}.  \todo{[Give more specific citations, and/or present details?]}  So we have an endofunctor $(-)^\Cxt$ on $\CwF^\Id$. However, the monad structure does \emph{not} lift to $\CwF^\Id$: the multiplication turns out not to preserve $\Id$-contexts strictly.  (This could presumably be accommodated by developing a theory of pseudo-maps of $\CwF^\Id$'s.)

Similar considerations let us lift it to act as an endofunctor on CwF's with any of $\Sigma$-types, $\Pi$-types, the functional extensionality rules, and most other standard constructors.

Varying our CwF's along the other axis, ``contextuality'', for each set of constructors $(-)^\Cxt$ lifts to an endofunctor on $\CwF_\diamond$, but not on $\CwF_\cxl$: its result is almost never contextual, since adjoining two types $A$ and $B$ to a context in succesion has the same result as adjoining $(A,B)$ in one step, so (as long as the original theory had any types at all) there can be no well-defined notion of length.
\end{para}

\begin{para} The \emph{slice} construction is one of the fundamental tools of the category--type~theory correspondence; however, in terms of CwF's, it is not exactly the ordinary categorical slice.

For $\C$ any CwF, and $\Gamma$ any object of $\C$, the \emph{(type-theoretic) slice} $\C \slice \Gamma$ has as objects dependent contexts over $\Gamma$, and morphisms and families structure induced by pullback along the map $\ob (\C \slice \Gamma) \to \ob \C$ sending $\Delta \in \Cxt_\C(\Gamma)$ to $\Gamma,\Delta$.

Slices are always contextual; in particular, by slicing each $\C \in \CwF_\diamond$ over $\diamond$, we obtain a coreflection $\CwF_\diamond \to \CwF_\cxl$.

In syntactic terms, slicing corresponds to taking variables into the context: judgements $\Delta \types \J$ in $\T \slice \Gamma$ correspond exactly to judgements $\Gamma, \Delta \types \J$ in $\T$.
\end{para}

\begin{para} \label{par:types-to-cxts}Combining this with the dependent contexts construction gives us an endofunctor of $\CwF_\cxl$:
$$ \CwF_\cxl \mono<300> \CwF_\diamond \to^{(-)^\Cxt} \CwF_\diamond \to^{- \slice \diamond} \CwF_\cxl$$

An object of the resulting $\C^\Cxt \slice \diamond$ can be seen as an object $A_1,\ldots,A_k$ of $\C$ together with a partition $k = \sum_{i \leq l} k_i$, thought of as dividing the context into chunks: 
$$(A_1,\ldots,A_{k_1});\ (A_{k_1 + 1}, \ldots , A_{k_1 + k_2});\ \ldots ;\  (A_{\sum_{i < l}k_i + 1}, \ldots, A_k).$$
A ``type'' over such an object is then a dependent context over the full (un-chunked) context in $\C$; context extension adjoins the dependend context as a single additional chunk.  There is a natural inclusion $\C \mono \C^\Cxt \slice \diamond$, chunking each context into individual types.

This construction will be briefly but crucially useful to us, in Corollary \ref{cor:types-to-cxts}.
\end{para}

\begin{para} With some of our constructors, we can also construct \emph{co-slice theories}.  In a co-slice $\Theta \coslice \C$, an object is a map $g \colon \Theta \to \Gamma$ of $\C$ (a \emph{$\Theta$-pointed object of $\C$}); a map $(g,\Gamma) \to (d,\Delta)$ is a map $f \colon \Gamma \to \Delta$ of $\C$ with $fg = d$ (i.e.\ preserving the ``point''); and a type over $(g,\Gamma)$ is a type $A \in \Ty(\Gamma)$ together with a term $a$ of $g^*A$, or equivalently a point $(g,a) \colon \Theta \to \Gamma, A$ for which $\pi_{\Gamma;A} (g,a) = g$.  

There is an obvious projection $\Theta \coslice \C \to \C$, forgetting points.

This construction preserves contextuality; it also extends to act on $\Id$-types, $\Sigma$-types, $\One$, and more generally on inductive types with a single unary constructor; but it does \emph{not} act on $\Pi$-types, nor on $\Bool$, $\Zero$, or most other type-formers.  This is familiar categorically: co-slices retain e.g.\ binary products and terminal objects, but not coproducts or exponentials.
\end{para}

\begin{para}[Normalisation results]  It is a fundamental fact, going back to \cite{martin-lof:predicative-part}, that the basic structural theory together with any subset of the standard constructors ($\Id$-, $\Sigma$-, $\Pi$-types, and also $\Nat$ and $\Bool$) is strongly normalising.

Moreover, it is easy to see \todo{[but is it proven anywhere citable??]} that this result extends to theories including algebraic type- and term-forming axioms.  (It can fail, however, under the addition of algebraic definitional equality axioms.)  In particular, \ldots

\todo{[Problem: I can't figure out how to give a general result of the form I want: ``in some class of simple theories, all closed normal forms are canonical, and so any closed forms that are propositionally equal are definitionally so''.  However, I can't find a succinct description of a suitable class of theories.  I guess it's just OK to give normalisation here, and invoke ththe further result when I use it?  But I'd like to be able to refer to this result specifically\ldots  Hm.]}

It is currently somewhat unclear to what extent one can retain strong normalisation in conjunction with the functional extensionality rules.  The Observational Type Theory of Altenkirch and collaborators (\cite{altenkirch:ott}, \cite{altenkirch-mcbride-swierstra}) achieves this, but has \emph{defined} rather than axiomatic identity types (and therefore does not easily permit extension by further type axioms), and moreover forces these to be trivial: any two terms of an identity type are equal (the UIP axiom of \cite{hofmann:extensional??}).  However, the OTT system is an encouraging step towards the development of a fully intensional system with functional extensionality.  (The difficulty lies essentially in defining the computational behaviour of the extensionality combinator; this seems to be related to the difficulties of the principle $\Jbar$ of Section \ref{sec:jbar}.)
\end{para}






























\section{Globular structures from $\DTT$}

\todo{[Recall from background: general construction of $\Spans(\C)$, operads therein.  Homming-out facts? or put those in main body?]}

\todo{[Give: the globes, and variants of globes; the Kan constructions; fact that pasting diagrams get realised by these; resulting functors $\DTT \to \Alg{\End(\globes)}$.]}

\subsection{Endomorphism operads; categories with fibrations: Background}
\label{subsec:endo-operads}

To open: Quickly recall (as in prev paper) strict $\omega$-categories.

To do here: Recall from \cite{batanin:natural-environment} Globular monoidal categories; operads.

In moving to the weak case, we wish to formalise the idea that our laws may hold only up to homotopy: there may be not just one way of composing a given pasting diagram, there may be several, although they will all be equal up to cells of the next dimension. 

This is formalised in the notion of a \emph{contractible globular operad}.  There are several equivalent presentations of this idea, as given in e.g. \cite{batanin:natural-environment}, \cite{leinster:book}, and \cite{weber:operads-within}.

The presentation of Leinster (\cite{leinster:book}) (which I used in \cite{lumsdaine:tlca}), via cartesian monads and generalised multicategories, is perhaps the most accessible approach, but is less general than the others.  Some constructions may be extremely elegantly presented in this setting, but others become rather difficult.

The original presentation of Batanin (\cite{batanin:natural-environment}), via monoidal globular categories in general and $\Spans$ in particular, is more elementary, but with this approach it can be difficult sometimes to see the wood for the trees; constructions in this setting are typically long but comparatively straightforward to verify.  

The presentation of Weber (in e.g. \cite{weber:operads-within}), via \emph{monoidal pseudo-algebras} is, essentially, an abstraction of Batanin's approach, on the one hand allowing more generality, and on the other hand giving a clearer picture of how the various elements of Batanin's definition relate and fit together; \cite{weber:operads-within} also explicates the connection with Leinster's presentation.

Here, we will use mostly the Batanin monoidal globular categories presentation, with occasional hints at the bigger picture of general monoidal pseudo-algebras, and a brief discussion of the connections with the use of Leinster's presentation in \cite{lumsdaine:tlca}.

The setting for each of these approaches is the 2-category $[\G^\op,\Cat]$ of \emph{globular categories}, or equivalently, of \emph{internal categories in globular sets}: $\intCat[[\G^\op,\Sets]]$.  From the latter description, we see that the strict $\omega$-category monad $T_\str$ on $[\G^\op,\Sets]$, being cartesian, gives a 2-monad $\Tcal_\str := \intCat[T_\str]$ on globular categories.

\begin{definition}[Weber, \protect{\cite[2.2; 6]{weber:operads-within}}]
A \emph{Weber monoidal globular category} is a normalised pseudo-algebra for $\Tcal_\str$.  Together with pseudo-homomorphisms and pseudo-2-cells, these form a 2-category $\PsAlg[0]{\Tcal_\str}$.
\end{definition}

\begin{definition}[Batanin] \cite[2.3]{batanin:natural-environment} More concretely, though less succinctly, a \emph{(Batanin) monoidal globular category} is a globular category 
$$\xymatrix{ \C_0 & \ar@<0.5ex>@{->>}[l]^s \ar@<-0.5ex>@{->>}[l]_t \C_1 & \ar@<0.5ex>@{->>}[l]^s \ar@<-0.5ex>@{->>}[l]_t \C_2 & \ar@<0.5ex>@{->>}[l]^s \ar@<-0.5ex>@{->>}[l]_t \cdots};$$
together with functors
$$ \tensor_k \colon \C_n \times_k \C_n \to \C_n, $$
$$ Z \colon \C_n \to \C_n+1 $$
satisfying source and target conditions analogous to those for composition and identities in a strict $\omega$-category, e.g.\ $s \cdot Z = 1 = t \cdot Z$, $s_i \cdot \tensor_k =  \tensor_k \cdot (s_i \times s_i)$ for $i > k$,  $s_i \cdot \tensor_k =  s_i \cdot \pi_2$ for $i \leq k$, etc;
natural isomorphisms analogous to the associativity and unitality axioms of a srtict $\omega$-category:
$$\alpha : R \tensor_k (S \tensor_k T) \iso (R \tensor_k S) \tensor_k T$$
$$\varepsilon_l : Z^{n-k}A \tensor_k R \iso R$$
$$\varepsilon_r : R \tensor Z^{n-k}A \iso R;$$
all satisfying various coherence axioms.

A pseudo-map of monoidal globular categories is\ldots

A pseudo-transformation between these is\ldots

Together, these form a 2-category $\MonGlobCat$.
\end{definition}

\begin{theorem}[\cite{weber:operads-within}] There is a 2-equivalence $\PsAlg{\Tcal_\str} \equiv_2 \MonGlobCat$.
\end{theorem}

This justifies our description of these definitions as, \emph{for 2-categorical purposes}, equivalent.  However, their underlying 1-categories (with non-identity 2-cells discarded) are not equivalent (CHECK CAREFULLY!), and it will not always be patently transparent that we deal only 2-categorically with them; so by ``monoidal globular category'', unmodified, we will always mean the Batanin version.

\subsection{Categories with fibrations: three variations on a theme}


We want to write: If $\C$ is a category with\ldots what?  ``a class of fibrations'' seems simplest, but in writing that down and refining the definition to be as principled as possible here, I just end up continuously deforming it into something much closer to a category with families.  Well\ldots let's go for the simplest and worry about making it more principled later.  Basically, the principled version should emphasise that being a fibration is extra structure, not a property\ldots or might not even be a structure: $\F$ needn't be an isofibration over $\C^\arr$.

OK: \emph{give} these three versions; show the continuous deformation!  It's interesting!

\begin{definition}(New version of the preceding.)  A category with \emph{right maps} is a category $C$ with a distinguished replete class $\R$ of maps (usually called \emph{right maps}\footnote{named by analogy with Right Whales} or \emph{fibrations}) such that:
\begin{enumerate}
\item considered as a subcategory of $\C^\Two$, $\R$ is closed under isomorphism;
\item $\R$ is closed under all pullbacks (i.e.\ chosen(?) pullbacks of right maps along all maps exist and are again right maps); and
\item $\R$ is closed under composition and contains identities.
\end{enumerate}

A \emph{class of left maps} is of a class of maps satisfying the dual axioms: closed under isomorphism, all pushouts, composition and identities and. 
\end{definition}

However, in practice one works with left or right maps as extra \emph{structure}, or ``\emph{co-structure}'', on maps of $\C$: for instance, cloven fibrations of categories, or Serre cofibrations presented as (retracts of) relative cell complexes.  This approach is systematically studied in the context of \emph{algebraic weak factorisation systems} (Tholen, Garner, et al (select citations!)); again, the definition we consider here is somewhat weaker.

\begin{definition}A category with \emph{structured right maps} is a category $\C$, together with a category $p \colon \F \to \C^\Two$, such that:
\begin{enumerate}
\item $p$ is a cloven isofibration;
\item $\cod \cdot p \colon \F \to \C$ is a cloven fibration, and $p$ sends cartesian arrows to pullback squares;
\item $p$ is a monoid with respect to the monoidal structure on $\Cat/\C^\Two$ given by $f \tensor g = (\dom \cdot f) \times_\C (\cod \cdot g)$, and the unit and multiplications structures are maps of cloven fibrations over $\C$.
\end{enumerate}

\emph{Structured right maps} are defined dually: $\cod \cdot p$ is a cloven opfibration, and $p$ sends co-cartesian arrows to pushout squares.
\end{definition}

These conditions are just algebraisations of those of the previous definition.  The monoidal structure tells us that for a composable pair of right maps $A \to^\fbf B \to^\gbf C$ (with underlying maps $A \to^f B \to^g C$), there is a right map $\gbf \cdot \fbf$, and so on.  That the structure maps preserves cleavings tell us that these compositions and identities are preserved by pullback: $k^* (\gbf \cdot \fbf) = (k^* \gbf) \cdot ((\gbf^*k)^* \fbf)$.

However, in practice again, the most natural presentation of (co)fibrations is sometimes not as structures on maps of $\C$, but as structures over objects of $\C$. 
In the case of Serre cofibrations, again, ``relative cell complexes over (check wording: `over'? `extending'?) a base space $B$'' are more fundamental objects, and often more convenient to work with, than ``maps out of $B$, with isomorphisms to the realisation of some cell complex''.  (This example isn't great, since definition of cell complex varies and with some it's \emph{always} only up to iso; maybe needs tweaked.)  Similarly, in our fundamental type-theoretic example, the map $\Gamma \to \Gamma,1$ (in a theory with strong unit types) is isomorphic to $1_\Gamma$ or $\Gamma,1 \to \Gamma$, but is not itself the dependent projection from any context extension; we may work with the \emph{context extensions} themselves, rather than with the class of ``maps isomorphic to some dependent projection''.

This also arises in the formalisation of mathematics in dependent type theories, and more generally in the formation of internal structures in model categories and similar environments\ldots  [explain more!]

To accommodate this, we simply drop the condition in the previous definition that $p$ should be an isofibration.  This brings us to the definition:

\begin{definition}
A \emph{something} on a category $\C$ is a functor $p: \F \to \C^\Two$, such that $\cod \cdot p$ is a cloven fibration, $p$ sends cartesian maps to pullback squares, and $p$ is equipped with a monoid structure in $(\Cat/\C,\tensor)$, whose structure maps preserve the cleavings.
\end{definition}

But we've seen this before!  This is simply a comprehension structure on $\C$ with strict sum and unit types, as defined in Section \ref{sec:comprehension} above, arrived at from a different direction.

Connecting these three, we have adjunctions over $\Cat$:

$$\CompCat_{\textrm{v-str-sum}} \two/->`<-/^F_U \Cat\mbox{-}\mathbf{StrRMaps} \two/->`<-/^F_U \Cat\mbox{-}\mathbf{ClsRMaps}$$

of which the second is a reflection, and the first might be (????) a $2$-equivalence.

 Then we can define a monoidal globular category $\FibSpans_\R(\C)$ (or just $\FibSpans(\C)$, when $\R$ is clear from context) as follows: \ldots  \todo{Do this!}

A globular object in $\FibSpans(\C)$ is then just a globular object $\X$ in $\C$, all of whose source and target maps are fibrations.

Given such a globular object $\X$, its ``diagram objects'' $X^\pi$ in $\FibSpans$ are computed by $X^\pi = \lim_{c \in \widehat{\pi}_n} X_n$.  More precisely, the diagram objects of $\X$ are themselves higher spans; these are the objects of $\C$ that appear in those spans \ldots  \todo{[Give pylon diagram!]}

(So if $\C$ has enough limits that the pointwise right Kan extension $\Ran_{\yon}(\X) : \GSets^\op \to \C$ exists, then these objects are computed by it: $X^\pi = \Ran_{\yon}(\X)(\pi)$.)

So elements of the endomorphism operad consist in \emph{pylon diagrams} as follows: [diagram].

\begin{example}
If $\C$ is any category with all pullbacks, then by taking the right maps to be all maps, we have the case $\FibSpans(\C) = \Spans(\C)$, as constructed in \cite{batanin:natural-environment}.
\end{example}

\begin{example}
The classifying category $\cl(\T)$ of a type theory, with the right maps as dependent projections.  This is of course our fundamental application!
\end{example}

\begin{example}
$\Top^\op$, with relative cell complexes.  Better, think of these as left maps in $\Top$; and think of $\CofCosps(\Top) := \FibSpans(\Top^\op)$.
\end{example}

\subsection{\ldots and with left and right maps}

(Adapted from Richard and Benno's analysis in \cite{garner-van-den-berg}.)

\begin{definition}A \emph{category with left and right maps} is a category $\C$, with a class $\R$ of right maps as above, and a class $\L$ of left maps, closed under pushout and composition and identities and weakly orthogonal to the right maps.  (Note: no factorisations asked for!) 

(Again, should make this more principled/algebraic: not classes of maps, but extra (co-)structure on maps, etc.)
\end{definition}

\begin{example} \label{ex:left-maps-from-right} A very well-known example: If $\C$ is any category with a class $\L$ of left maps, we can define right maps $\L^\pitchfork$ to be the class of maps weakly orthogonal to all maps in $\L$.  \cite{hovey-find-orthogonality}  Indeed, we may start with any class $\I$ of maps, without any axioms needed; $\I^\pitchfork$ will always satisfy the axioms for a class of right maps.

Algebraising this (\cite[3.8]{garner:understanding}), given any functor $U : \I \to \C^\Two$, we can define a class of structured right maps $\R = (\I,U)^\pitchfork$ by defining an $\R$-structure on $f$ to consist of a choice of diagonal filler for every square
$$\xymatrix{ \bullet \ar[r] \ar[d]_{Ui} & \bullet \ar[d]^f \\ \bullet \ar[r] & \bullet }.$$

Or, more coherently: equipped with \emph{coherent} such choices, equivalently with a filler for every \emph{triangle}, from which coherent choices are then determined via pullbacks.  Or, most relevantly at all: this, but starting just with triangles from a given \emph{generating set} or $\R$-maps.) [currently very cryptic, flesh it out!]
\end{example}

\begin{example}$\Top$, with relative cell complexes as left maps, and fibrations as right maps.
\end{example}

\begin{definition}For any other class of maps $\K$, a \emph{$\K$-absolute left (resp.\ right) map} in such a category is a map whose every pullback (pushout) along a $\K$-map is a left (right) map.  (NB: when $\K$ contains identities (it always will) this includes, of course, the map itself.)  When $\K$ is unspecified, ``absolute left map'' will generally mean $\R$-absolute, and vice-versa.

(Algebraically: \ldots with a chosen left- (right-)map structure on its every pullback (pushout)\ldots)  
\end{definition}

\begin{example}In a classifying category $\cl(\T)$, with left maps determined by right maps as described above, the elim- and comp-rules give a left-map structure on the intro context morphism for any single-intro-rule constructor; this left map is absolute if the elim-rule is given with a Frobenius condition.
\end{example}

Now, work in a category $\C$ with left and right maps.  Suppose $\X$ is a globular object in $\FibSpans$, i.e.\ a globular object in $\C$; and suppose $\X$ extends to a \emph{reflexive} globular object, whose reflexivity maps $r$ are all absolute left maps.

Then a whole bunch of maps between the objects $X^\pi$ are also left maps!  \ldots which ones??  Well\ldots any that realise maps of reflexive globular sets that can be built as composites of pushouts of $r$'s along composites of $s$'s and $t$'s.  In particular, any map $X^\rho \to X^\pi$ induced by an injection of Batanin trees $\tree(\pi) \to \tree(\rho)$ is a left map.

(This is very cryptic!  Give examples of what this means.)

\begin{example}
In $\cl(\T)$, for a theory with identity types, the tower of identity types is a globular object of this sort.  From this it is a short step (see \cite{lumsdaine:tlca-journal}, \cite{garner-van-den-berg}, and \ref{subsec:endo-contractible} below) to constructing the fundamental weak $\omega$-groupoid of a type.
\end{example}

(Note: $\Top$ doesn't seem to quite give an example of this setup$\ldots$ at least, I can't see what classes of left/right maps make the reflexivity maps \emph{absolute} right-maps.  e.g.\ They're absolute w.e.'s since they have triv-cof sections, but they're not absolute fibrations; the particular pushouts involved do end up still giving fibrations, but I can't see an abstract explanation for why.)

We can spin further variations on this principle.  In particular:

\begin{proposition}
Suppose $\C$ has left and right maps $\L \pitchfork \R$, and another class of left maps $\L' \supseteq \L$.  Suppose $\X$ is a globular object in $\CofCosps_{\L'}(\C)$, with reflexivity sections in dimension $\geq 1$ that are $\L'$-absolute $\R$-maps.  Then for any injection of Batanin trees $\tree(\pi) \to \tree(\rho)$ that is the identity in dimension $\leq 1$, the induced $X^\rho \to X^\pi$ is an $\R$-map.
\end{proposition}


\subsection{The type-theoretic globes}

\begin{para} Once again, let $\stuff$ be some set of rules/constructors, including at least the $\Id$-rules.  The \emph{type-theoretic globes} over $\stuff$ are then a sequence of theories $\globe[n]^\Phi$ which play a similar r\^o{}le in $\DTT_\stuff$ to that which the discs $D^n$ play in $\Top$: they are an internal weak-$\omega$-cocategory, and as such will---almost---be representing objects for the classifying weak $\omega$-category functor.
\end{para}

\begin{definition} $\globe[n]^\Phi$ is the theory over $\Phi$ generated by axioms $i$-$\sourcerule$, $i$-$\targetrule$ (for $0 \leq i < n$), and $n$-$\cellrule$, as follows:
$$
\inferrule*[right={0-$\sourcerule$}]{\ }{\diamond \types A\ \type} \qquad 
\inferrule*[right={0-$\targetrule$}]{\ }{\diamond \types B\ \type} \qquad 
\inferrule*[right={0-$\cellrule$}]{\ }{\diamond \types C\ \type}
$$
$$ 
\inferrule*[right={1-$\sourcerule$}]{\Gamma \types a : A}{\Gamma \types s_1(a): B} \qquad
\inferrule*[right={1-$\targetrule$}]{\Gamma \types a : A}{\Gamma \types t_1(a): B} \qquad
\inferrule*[right={1-$\cellrule$}]{\Gamma \types a : A}{\Gamma \types c_1(a): B} 
$$
$$
\inferrule*[right={$i$-$\sourcerule$}]{\Gamma \types a : A}{\Gamma \types s_i(a):\Id(s_{i-1}(a),t_{i-1}(a))} \qquad
$$
and $i$-$\targetrule$ , $i$-$\cellrule$\ exactly as $i$-$\sourcerule${} except with term-formers $t_i$, $c_i$ in place of $s_i$.
\end{definition}

We will usually work with some fixed $\Phi$, and write just $\globe[n]$.

\begin{para} There are evident interpretations between these theories, forming a reflexive coglobular object $\globes$ in $\DTT_\stuff$:

$$ \globe[0]\, \three/->`<-`->/<500>\ \globe[1]\, \three/->`<-`->/<500>\ \globe[2]\, \three/->`<-`->/<500> \ \ldots $$

Leaving aside the reflexivity for now, we can see the globes as a functor
$$ \globes \colon \GSets \to \DTT_\stuff .$$
Since $\DTT_\stuff$ is co-complete, this induces by general nonsense(\cite{find-citation-for-Kan-situation}) an adjoint pair of functors between $\GSets$ and $\DTT_\stuff$ (a ``Kan situation'').  Both these functors will be of central interest to us in the sequel:
$$\quad \xymatrix{ \GSets \ar@/_/[rrr]_{\T_\stuff [-]\, :=\, \Lan_\yon \globes \qquad \ \, } \ar@{}[rrr]|\top & & & \DTT_\stuff \ar@/_/[lll]_{\cl^-_\omega\ :=\ \DTT_\stuff(\globes,-)} \\ \G \ar@{ >->}[u]^\yon \ar@/_/[urrr]_{\globes} }
$$

The right adjoint, $\cl^-_\omega \colon \DTT_\stuff\ \to\ \GSets$, is defined by homming out of the globes, i.e.\ by setting $\cl^-_\omega(\T)_n = \DTT_\stuff(\globe[n],\T)$.  Thus, by the definitions of the globes, the 0-cells of $\cl^-_\omega(\T)$ correspond exactly to closed types in $\T$; the 1-cells $A \to B$ to terms of $A$ dependent on a single variable from $B$; the 2-cells to terms of type $\Id_B$ between 1-cells; and so on.

This is very nearly, but not quite, what we wanted for the underlying globular set of $\cl_\omega(\T)$.  The difference is that it has only the \emph{types} of $\T$ as 0-cells, not all the contexts; however, we will proceed for now with $\cl^-_\omega$, and remedy this deficiency later.

Meanwhile, the left adjoint $\T_\stuff [-] \colon \GSets\ \to\ \DTT_\stuff$ is constructed as the left Kan extension of $\globes$ along $\yon$, and may be seen as freely adjoining a globular set to $\T_\stuff$, using the globes as templates.  Explicitly, for a globular set $\X$, the theory $\T[\X]$ has axioms for each cell of $\X$, realising the 0-cells as closed types, the 1-cells as terms between these types, and the higher-cells as terms of appropriate identity types.\footnote{A related construction is considered in \cite{awodey-hofstra-warren} and \cite{hofstra-warren}, corresponding to a slightly different co-globular theory: they omit our $\globe[0]$, giving instead just a single closed base type, and realise $0$-cells as closed terms of this type, $1$-cells as terms of identity type between these, and so forth.  Their $T_\mathbf{ML}$ is then the monad induced by the Kan adjunction.}

 In particular, $\T_\stuff[\yon(n)] = \globe[n]$.  Also useful will be the boundary of the  $n$-globe, $\del \globe[n] := \T_\stuff[\del \yon(n)]$; up to isomorphism, this is the theory given by $i$-$\sourcerule$ and $i$-$\targetrule$, for $0 \leq i < n$, i.e.\ all the axioms of $\globe[n]$ except for $n$-$\cellrule$ itself.
\end{para}
 
\begin{para} Since $\DTT_\stuff$ is co-complete, we can consider (by Section \ref{sec:endo-operad}) the co-endomorphism operad of the globes, $\End_{\Spans(\DTT_\stuff^\op)}(\globes)$, or briefly just $\End(\globes)$.  We know that its operations of some shape $\pi$ are given by
$$\End(\globes)(\pi) \iso [\G/n,\DTT_\stuff](\globes \cotensor \hat{\pi},\globes \cotensor \yon(n))$$
and hence, unwinding this formula, consist of pylon diagrams as in Fig.\ \ref{fig:endo-pylons}.

\begin{figure}[htbp]
$$\bfig
%%%%%%%%%%%%%%%%%%%
% left hand pylon %
%%%%%%%%%%%%%%%%%%%
\node gn(250,0)[\globefig{n}]
\node gn1l(0,-250)[\globefig{n-1}]
\node gn1r(500,-400)[\globefig{n-1}]
\node gn2l(0,-650)[\globefig{n-2}]
\node fakegn2l(450,-650)[]
\node gn2r(500,-800)[\globefig{n-2}]
\node g1l(0,-1150)[\globefig{1}]
\node g1r(500,-1300)[\globefig{1}]
\node g0l(0,-1550)[\globefig{0}]
\node g0r(500,-1700)[\globefig{0}]
\arrow[gn1l`gn;]
\arrow[gn1r`gn;]
\arrow[gn2l`gn1l;]
\arrow[gn2r`gn1l;]
\arrow[gn2l`gn1r;]
\arrow[gn2r`gn1r;]
\arrow/@{}|<>(0.58)\vdots/[g1l`gn2l;]
\arrow/@{}|<>(0.58)\vdots/[g1r`gn2r;]
\arrow[g0l`g1l;]
\arrow[g0r`g1l;]
\arrow[g0l`g1r;]
\arrow[g0r`g1r;]
%%%%%%%%%%%%%%%%%%%%
% right hand pylon %
%%%%%%%%%%%%%%%%%%%%
\node Tpi(1750,0)[{\T_\Phi[\widehat{\pi}]}]
\node Tspi(1500,-250)[{\T_\Phi[\widehat{s\pi}]}]
\node Ttpi(2000,-400)[{\T_\Phi[\widehat{t\pi}]}]
\node Ts2pi(1500,-650)[{\T_\Phi[\widehat{s^2\pi}]}]
\node Tt2pi(2000,-800)[{\T_\Phi[\widehat{t^2\pi}]}]
\node Ts1pi(1500,-1150)[{\T_\Phi[\widehat{s_1\pi}]}]
\node Tt1pi(2000,-1300)[{\T_\Phi[\widehat{t_1\pi}]}]
\node Ts0pi(1500,-1550)[{\T_\Phi[\widehat{s_0\pi}]}]
\node Tt0pi(2000,-1700)[{\T_\Phi[\widehat{t_0\pi}]}]
\arrow[Tspi`Tpi;]
\arrow[Ttpi`Tpi;]
\arrow/@{>}|!{(500,-400);(2000,-400)}\hole/[Ts2pi`Tspi;]
\arrow/@{>}|!{(500,-400);(2000,-400)}\hole/[Tt2pi`Tspi;]
\arrow[Ts2pi`Ttpi;]
\arrow[Tt2pi`Ttpi;]
\arrow/@{}|<>(0.58)\vdots/[Ts1pi`Ts2pi;]
\arrow/@{}|<>(0.58)\vdots/[Tt1pi`Tt2pi;]
\arrow/@{>}|!{(500,-1300);(2000,-1300)}\hole/[Ts0pi`Ts1pi;]
\arrow/@{>}|!{(500,-1300);(2000,-1300)}\hole/[Tt0pi`Ts1pi;]
\arrow[Ts0pi`Tt1pi;]
\arrow[Tt0pi`Tt1pi;]
%%%%%%%%%%%%%%%%%%%%
% connecting wires %
%%%%%%%%%%%%%%%%%%%%
\arrow[gn`Tpi;H]
\arrow/@{>}|!{(250,0);(500,-400)}\hole/[gn1l`Tspi;F_{n-1}]
\arrow[gn1r`Ttpi;G_{n-1}]
\arrow/@{>}|<>(.19)\hole|!{(500,-800);(500,-400)}\hole/[gn2l`Ts2pi;F_{n-2}]
\arrow[gn2r`Tt2pi;G_{n-2}]
\arrow[g1l`Ts1pi;F_1]
\arrow[g1r`Tt1pi;G_1]
\arrow/@{>}|<>(.21)\hole|!{(500,-1700);(500,-1300)}\hole/[g0l`Ts0pi;F_0]
\arrow[g0r`Tt0pi;G_0]
\efig$$
\caption{Operations in an endomorphism operad\label{fig:endo-pylons}}
\end{figure}
\end{para}

\begin{para} By Lemma \ref{lemma:homming-out-of-P-alg}, $\End(\globes)$ acts naturally on $\cl^-_{\omega}$.  This allows us to lift $\cl^-_\omega$ to a functor into $\Alg{L} = \wkwCat$, which by abuse of notation we still denote $\cl^-_\omega$:

$$\bfig
\node DTT(0,0)[\DTT_\Phi]
\node EndGAlg(1100,500)[\Alg{\End(\globes)}]
\node GSets(1400,0)[\GSets]
%\node wkwCat(900,500)[\wkwCat]
\arrow[DTT`GSets;\cl^-_\omega]
\arrow[DTT`EndGAlg;\cl^-_\omega]
%\arrow[EndGAlg`wkwCat;]
\arrow[EndGAlg`GSets;U]
%\arrow[wkwCat`GSets;]
\efig$$

Moreover, since $U$ reflects and the original $\cl^-_\omega$ preserves all limits, so does the lifted $\cl^-_\omega$; so since both $\DTT_\Phi$ and $\Alg{\End(\globes)}$ are nice categories, we see by the Something Adjoint Functor Theorem \todo{find reference for most easily applicable form} that $\cl^-_\omega$ has a left adjoint, realising any $\End{\globes}$-algebra as a theory.  (Its cells are realised as types and terms as under $\T_\Phi[-]$, and the $\End{\globes}$-action specifies various definitional-equality axioms between them.)
\end{para}

\begin{para} As mentioned before, this is not quite what we want; $\cl^-_\omega(\T)$ only has types as objects, where we would like contexts.  To remedy the situation, we can compose with the ``dependent contexts'' endofunctor $(-)^\cxt \slice \diamond$ on $\DTT_\stuff$, and define $\cl(\T) := \cl^-_\omega(\T^\cxt \slice \diamond)$.

Now the objects of $\cl(\T)$ are closed types of $\T^\cxt \slice \diamond$, i.e.\ closed contexts of $\T$, just as we wanted; and the fullness of the functor $\T^\cxt \slice \diamond \to \T$ ensures that higher cells also are as we intended.
\end{para}

\begin{para} In Section \ref{sec:contractibility} below, we will investigate the question of when $\End(\globes)$ is contractible, or at least of finding a contractible suboperad.  This will require, however, the development of some more type-theoretic machinery.  For now, we may content ourselves with showing that at least in dimensions $\leq 1$, $\End(\globes)$ is very nice.

Specifically, recall that there is an adjunction
$$ \nOpd[1] \two/->`<-/^{D}_{\tr^1} \nOpd[\omega]$$
where $DQ$ is the \emph{discrete} $\omega$-operad on a 1-operad $Q$, with only unit cells (i.e.\ units of the operad structure) in higher dimensions, and $\tr^1P$ is the 1-truncation of an $\omega$-operad $Q$, with $\tr^1(P)_i = P_i$ for $i \leq 1$.  % (In fact $\tr^1$ also has a right adjoint, but that will not concern us here.)  \todo{[Hmm, is this true??]}
\todo{[Check Batanin's terminology: (co-)skeleton, (co-)truncation??]}

Now take $P_\Cat \in \nOpd[1]$ to be the operad for categories, i.e.\ the terminal $\nOpd[1]$.  Then there is a map $D(P_{\Cat}) \to \End(\globes)$, or equivalently $\psi \colon P_{\Cat} \to \tr^1 \End(\globes)$.  Truncating algebras and pulling back along this map thus induce a map $\psi^* \Alg{\End(\globes)} \to \Cat$, which when applied to $\cl_\omega(\T)$ simply recovers the classifying category $\cl(\T)$:
$$\bfig
\node DTT(0,0)[\DTT_\Phi]
\node EndGAlg(1000,500)[\Alg{\End(\globes)}]
\node trEndGAlg(2000,500)[\Alg{\tr^1 \End(\globes)}]
\node Cat(2800,500)[\Cat]
\node GSets(1400,0)[\GSets]
\node G1Sets(2400,0)[{\GnSets[1]}]
\arrow[DTT`EndGAlg;\cl_{\omega}]
\arrow[EndGAlg`trEndGAlg;\tr^1]
\arrow[trEndGAlg`Cat;\psi^*]
\arrow[EndGAlg`GSets;]
\arrow[trEndGAlg`G1Sets;]
\arrow[Cat`G1Sets;]
\arrow[DTT`GSets;\cl_{\omega}]
\arrow[GSets`G1Sets;\tr^1]
\arrow/@{>}@/^0em//[DTT`Cat;\cl]
\efig$$

This points us towards an easy abstract construction of the map $\psi$.  We know that the 1-globular object $\globe[0] \two/<-`<-/ \globe[1]$ represents the functor $\cl : \DTT_\Phi \to \Cat$; so by the Yoneda lemma, $\globe[0] \two/<-`<-/ \globe[1]$ must carry some co-category structure; but such a structure corresponds exactly to an operad map of the form we want.
\end{para}

\begin{para} \label{para:map-from-cat} However, explicitly constructing the map gives us an excuse to analyse low dimensions of $\End(\globes)$.  A 0-dimensional operation in $\End(\globes)$ is perforce just a unary map $\globe[0] \to \globe[0]$ (there is only one 0-dimensional pasting diagram); so the single 0-dimensional operation in $\Cat$ (the identity on 0-cells) we send to the identity map $1_{\globe[0]}$.  (There is no choice: $\psi$ must preserve the operad structure, and $1_{\globe[0]}$ is the $0$-dimensional operad unit of $\End(\globes)$.)

A 1-dimensional pasting diagram is just a path $\path_l = (\cdot \to<200> \cdot \to<200> \ldots \to<200> \cdot)$ of some length $l \geq 0$.  \todo{[Dangit, need a better notation than $\path_l$!]} An operation of shape $\path_l$ in $\End(\globes)$ with source and target $1_{\globe[0]}$ is a map of cospans
$$\bfig
%%%%%%%%%%%%%%%%%%%
% left hand pylon %
%%%%%%%%%%%%%%%%%%%
\node gn(250,0)[\globefig{1}]
\node gn1l(0,-250)[\globefig{0}]
\node gn1r(500,-400)[\globefig{0}]
\arrow[gn1l`gn;s]
\arrow[gn1r`gn;t]
%%%%%%%%%%%%%%%%%%%%
% right hand pylon %
%%%%%%%%%%%%%%%%%%%%
\node Tpi(1750,0)[{\T_\Phi[\widehat{\path_l}]}]
\node Tspi(1500,-250)[{\globefig{0}}]
\node Ttpi(2000,-400)[{\globe[0]}]
\arrow[Tspi`Tpi;s]
\arrow[Ttpi`Tpi;t]
%%%%%%%%%%%%%%%%%%%%
% connecting wires %
%%%%%%%%%%%%%%%%%%%%
\arrow[gn`Tpi;H]
\arrow/@{=}|!{(250,0);(500,-400)}\hole/[gn1l`Tspi;]
\arrow/@{=}/[gn1r`Ttpi;]
\efig$$

But $\T_\Phi(\path_l)$ admits a very simple axiomatisation
$$
\inferrule{\ }{\diamond\ \types\ A_i\ \type} \quad (0 \leq i \leq l) \qquad 
\inferrule{\Gamma\ \types\ a:A_{j-1}}{\Gamma\ \types\ f_j(a) : A_j } \quad (1 \leq j \leq l) 
$$
simply adjoining basic types and type formers
$$ \xymatrix{ A_0 \ar[r]^{f_1} & A_1 \ar[r]^{f_2} & \ \ar@{}[r]|{\ldots} & \ \ar[r]^{f_l} & A_l} .$$

The source and target maps of the right-hand cospan interpret the type of $\globe[0]$ as $A_0$ and $A_l$ respectively; so suitable maps $H : \globe[1] \to \T_\Phi[\path_l]$ correspond to interpretations of the type-constructor of $\globe[1]$ as some term
$$ x : A_0 \ \types\ t(x) : A_l $$
For the unique $l$-ary operation of $P_\Cat$, we thus use the obvious term $f_l(f_{l-1}(\ldots (f_1(x))\ldots))$.  It is routine to check that this indeed gives an operad map.
\end{para}

\begin{para} \label{para:canonicity-in-Tpath} When $\Phi$ gives a particularly well-behaved type system, we can say a little more.

In the case when $\Phi$ consists of just the $\Id$-rules, then firstly $\globe[0]$ has no other closed types besides the basic $C$, so $1_{\globe[0]}$ is its only endomorphism, and the only element of $\End(\globes)$ in dimension $0$; and secondly,  (\cite{canonicity-reference?}) $\T_\Phi[\path_l]$ enjoys both normalisation and \emph{canonicity}\footnote{canonicity: the property that every closed normal form is an intro (aka canonical) form; there are no stuck (aka neutral) normal forms}, so the ``obvious term'' we used was in fact the only possible such term: there is only one $l$-ary operation in $\End(\globes)$ with source and target $1_{\globe{0}}$.

So in this case, the map $P_\Cat \to \tr^1\End(\globes)$ (always injective, since $P_\Cat$ is terminal) is moreover surjective, so gives an isomorphism $\tr^1\End(\globes) \iso P_\Cat$.

In richer type systems, $\globe[0]$ will typically have more closed types (e.g.\ $C \rightarrow C$), and hence $\End(\globe[0])$ will have more $0$-dimensional operations.  But in important cases, such as when $\Phi$ consists of just the $\Id$- and $\Pi$-rules, we retain normalisation and canonicity for $\T_\Phi[\path_l]$, so by the argument above our map is at least an isomorphism from $P_\Cat$ to the \emph{normalised core} of $\End(\globes)$.\todo{[Define the normalised core in the globular background!]}
\end{para}




\subsection{A variant for $\Pi$-types}

\begin{para} We can also consider a variant set of globes ${}^\Pi \globes$, for any set of constructors including $\Pi$-types.  The axioms for each $\globe^\Pi$ are selected from rules $i$-$\sourcerule$-$\Pi$, $i$-$\targetrule$-$\Pi$, $i$-$\cellrule$-$\Pi$, analogously to the axioms for $\globe$.  These axioms differ from before in dimensions $\geq 1$, by using closed rather than open terms:
$$ 
\inferrule*[right={1-$\sourcerule$-$\Pi$}]{\ }{\Gamma \types s_1: S_0 \rightarrow T_0} \qquad
\inferrule*[right={$i$-$\sourcerule$-$\Pi$}]{\ }{\Gamma \types s_i:\Pi_{x:S_0} \Id(s_{i-1}(x),t_{i-1}(x))} \qquad \mbox{etc.}
$$

As before, we get a Kan adjunction
$$ \GSets \two/->`<-/^{\T_\Phi[-]^\Pi}_{{}^\Pi \cl^-_\omega} \DTT_\Phi $$
and lift $\clpi^-_\omega$ to $\Alg{\End({}^\Pi \globes)}$; also as before, we ``correct'' the functor $\clpi^-_\omega$ by precomposing with $(-)^\cxt \slice \diamond$, to get an alternate candidate for the classifying weak $\omega$-category:
$$ \clpi_\omega \colon \DTT_\Phi \to \Alg{\End({}^\Pi \globes)}$$

The objects of $\clpi_\omega (\T)$ are the same as those of $\cl_\omega(\T)$.  The difference is in the higher cells: rather than open context maps, $1$-cells are now context maps from the empty context $\diamond$ into ``$\Pi$-contexts'', and higher cells are context maps from $\diamond$ into the identity contexts over these.

\todo{[Question: do we also need $\Pi-\eta$, at least propositionally, to get contractibility of operad in dimension 1?  I think so.]}
\end{para}














\section{Homotopical structures on $\DTT$}

Recall from background: orthogonality; other exples of cofibrantly generated wfs' (or include these in main text??)

Include: basic extensions; contractible maps; $\Jbar$ and discussion.

\subsection{Left and right maps in $\DTT$}

\begin{para} In the next section, we'll construct classifying weak $\omega$-categories for theories with $\Id$-types and $\Pi$-types (with $\eta$-rules and functional extensionality), and discuss how it might be possible to extend this to require only the $\Id$-types.

The construction of the classifying weak $\omega$-category of a theory is closely analogous to that of the fundamental weak $\omega$-groupoid of a space: it is obtained by homming out of a complex of representing objects (``globes''), and so it is enough to show that these representing objects form a co-(weak $\omega$-category), just as the topological globes ($D^0$, $D^1$, $D^2$) [diagram!] do in $\Top$.

To that end, we set up in this section various classes of left and right maps on $\CwF^{\stuff}_\diamond$, and
then apply the machinery of Section \ref{sec:endo-operads} to show that the endomorphism operad of the globes is contractible.

Among this, only one step (showing that certain maps are absolute right maps) seems to require the $\Pi$-types for its proof.  In particular, we isolate and conjecture a certain type-theoretical principle, $\Jbar$, which would suffice for the proof of this step, and which seems to be of independent interest.  In particular, we discuss equivalent natural statements of $\Jbar$ from several rather different points of view: as a conservativity statement for certain theory extensions; as a second-order form of the $\Id$-elim rule; and as a form of observational equality for $\Pi$-types. 
\end{para}


\begin{para}[Type and term extensions]

For the remainder of this section, fix some collection $\stuff$ of the constructors and rules of Subsetcion \ref{subsec:construtors}, and work in $\DTT_\stuff$.  (The main cases of interest in the sequel are where $\stuff$ is either $(\Id)$, $(\Id,\Pi,\eta)$, or $(\Id,\Pi,\eta,\ext)$.)

For $n \geq 0$, we define theories $\T_\stuff[\Gamma_{(n)}]$, $\T_\stuff [\Gamma_{(n)} \types A]$, and $\T_\stuff [\Gamma_{(n)} \types a : A]$ to be the free theories on, respectively, a context of length $n$; a dependent type, in context of length $n$; and a term in such a type.  Axiomatically, each may be  specified by some subset of the rules below: $\T_\stuff[\Gamma_{(n)}]$ by the rules $i$-$\cxtrule$, for $0 \leq i < n$; $\T_\stuff [\Gamma_{(n)} \types A]$, by these rules together with $n$-$\typerule$; and $\T_\stuff [\Gamma_{(n)} \types a : A]$ by all of the above, together with $n$-$\termrule$:
$$\inferrule*[right={$i$-$\cxtrule$}]{\Gamma \types a_0:A_0\ \ldots\ \Gamma \types a_{i-1}:A_{i-1}}{\Gamma \types A_i(a_0,\ldots,a_{i-1})\ \type} \qquad \inferrule*[right={$i$-$\typerule$}]{\Gamma \types a_0:A_0\ \ldots\ \Gamma \types a_{i-1}:A_{i-1}}{\Gamma \types A(a_0,\ldots,a_{i-1})\ \type}$$
$$\inferrule*[right={$i$-$\termrule$}]{\Gamma \types a_0:A_0\ \ldots\ \Gamma \types a_{i-1}:A_{i-1}}{\Gamma \types a(a_0,\ldots,a_{i-1}) : A_i(a_0,\ldots,a_{i-1})}$$

(Of course, this gives $\T[\Gamma_{(n-1)} \types A] \iso \T[\Gamma_{(n)}]$; we retain the distinction just for notational clarity.)
\end{para}

\begin{para} The importance of these theories lies in their universal mapping properties.  For any theory $\T$, maps $\T_\Phi[\Gamma_{(l)}] \to \T$ correspond precisely to contexts of length $n$ in $\T$; maps $\T_\Phi[\Gamma_{(l)} \types A\ \type] \to \T$, to types over such a context; and maps $\T_\Phi[\Gamma_{(l)} \types a:A] \to \T$ to terms of such a type.

An analogy can profitably be drawn here between type theories and higher categories.  Globular higher categories are made up of cells, which are \emph{represented} by the free $n$-categories on individual cells.  Similarly, type theories are made up of judgements---contexts, types, and terms---which are represented by the theories above.

But now, many important apspects of higher category theory---in particular, their homotopical structure---can be described in terms of the inclusions of boundaries into those basic cells.  Much of this carries over substantially to type theories once we observe that \emph{judgements have boundaries too!}  ---indeed, this idea is already implicit in referring to e.g.\ $\Gamma \types a:A$ as a \emph{term judgement}: we are thinking of $a$ as the essential substance of the judement, and the function of $\Gamma$ and $A$ as just to situate $a$ within its surroundings.
\end{para}

The ``inclusions of boundaries into cells'' are thus defined as follows:

\begin{definition}
The \emph{universal type (resp.\ term) extensions} are the inclusion maps
$$ i^\ty_n \colon \T_\stuff [\Gamma_{(n)}] \mono \T_\stuff[\Gamma_{(n)} \types A],$$
$$ i^\tm_n \colon \T_\stuff [\Gamma_{(n)} \types A] \mono \T_\stuff[\Gamma_{(n)} \types a : A].$$

A \emph{basic term/type extension} is a pushout of one of the universal extensions.  A \emph{term/type/term-and-type extension} is any composite (possibly transfinite) of basic extensions.
\end{definition}

So in syntactic terms, a basic term extension is just any extension of a theory $\T$ by a new constructor $\x: A_1 \ldots A_{n-1}(\x^{< n-1})\ \types\ a(\x) : A_n(\x)$, where the $A_i$ are existing types of the theory.  Similarly, a basic type extension is an extension by a single algebraic term-forming axiom.  An arbitrary extension is any extension of theories formed by iteratively adding (possibly sets of) axioms of these forms.

The classes of term, type, and term-and-type extensions are all closed under composition, identities, and pushouts, so form classes of left maps in the sense of Section \ref{sec:endo-operads} above.  \comment{(They are not, however under retracts\ldots or at least, not obviously; are they actually?  Weak form of ``any sub-theory of a free theory is free\ldots''.)}

\begin{definition}A \emph{term-contraction} (resp.\ \emph{type-contraction}, \emph{contraction}) on a map $F \colon \T \to \S$ is an operation assigning a diagonal filler to every square
$$\xymatrix{ \T_\stuff[\Gamma_{(n)} \types A\ \type] \ar@{ >->}[d]_{i^\tm_n} \ar[r] & \T \ar@{->>}[d]^F \\ \T_\stuff[\Gamma_{(n)} \types a: A] \ar[r] \ar@{.>}[ur] & \S }$$
with left-hand-side a universal type (term, term or type) extension.  Assuming the axiom of choice, a map admits such fillers if and only if it is weakly orthogonal to all universal term (type, term and type) extensions, in which case it is called \emph{term-contractible} (\emph{type-contractible}, \emph{contractible}).  We will write $\R_\tm$, $\R_\ty$, $R_{\tm\ty}$ for the classes of contractible maps.
\end{definition}

The class of maps to which some given map is right orthogonal is always closed under pushouts and transfinite compositions \cite{hovey:closure}; so a type-contractible (term-contractible, contractible) map is in fact right orthogonal to all type (term, term-and-type) extensions.

\begin{para} Contractibility is familiar in type-theoretic terms as a form of conservativity.  Term-contractibility, for instance, states that whenever we have a type $\Gamma\ \types_\T\ A\ \type$ of $\T$ whose interpretation in $\S$ is inhabited by some term $F(\Gamma)\ \types_\S\ a:F(A)$, it is already inhabited in $\T$ by some term $\Gamma\ \types_\T\ \overline{a}:A$, which moreover is a \emph{lifting} of $a$, in that we can prove $F(\Gamma)\ \types_\S\ F(\overline{a}) = a : F(A)$ in $\S$.  Type-contractibility asserts the same sort of conservativity for types derivable in $\S$ over a context from $\T$.

This syntactic formulation of type-contractibility has been considered previously by Hofmann as a conservativity principle: see the discussion of logical frameworks in \cite[\SEC 4]{hofmann:syntax-and-semantics}.
\end{para}

\begin{para} Note that while neither form of contractibility directly provides any kind of lifting for definitional equality judgements, in the presence of identity types one can obtain weakforms of such liftings just from term-contractibility.  If for instance $\Gamma\ \types_\T\ a,a': A$ and $F(\Gamma)\ \types_\S\ F(a) = F(a'):F(A)$, then term-contractibility lets us lift $r(a)$ to some term $\Gamma\ \types_\T\ \overline{r(a)} : \Id_A(a,a')$.  Essentially, definitional equality for terms implies propositional equality, and for types, isomorphism-up-to-prop.-eq.; and since these are matters of term-judgements, they can be lifted along a term-contractible map. 

Often, term-contractibility implies type-contractibility.  In particular, in many important theories, the type-forming axioms do not mention any of the specific term-constructors.  From this it follows that any type judgment factors uniquely as a type judgement derivable without any term-formers (the ``shape'' of the type), followed by substitution along some context morphism.  Now if $F \colon \T \to \S$ is a morphism between two theories with this property, and $\S$ has the same type-forming rules as $\T$, then if $F$ is term-contractible, it is also type-contractible.  [Give this in more detail??  We never actually need it later, but it's an interesting fact.]
\end{para}

\begin{para} Since the classes of contractible maps are defined by an orthogonality condition, they are easily seen to be closed under retracts, by the standard argument (see eg \cite[where?]{hovey}).  This can be seen by a brief diagram-chase:  
$$\xymatrix{ \bullet \ar[r] \ar@{ >->}[d]_i & \bullet \ar[r] \ar[d]^f & \bullet  \ar[r] \ar@{->>}[d]^g & \bullet \ar[d]^f \\ \bullet \ar[r] \ar@{.>}[urr] & \bullet \ar[r] & \bullet \ar[r] & \bullet }$$
If $f$ is a retract of $g$, $g$ is contractible, and we are given a square from $i$ to $f$ to fill, take this as the leftmost square above, and build out to the right.  By the lifting property of $g$, we can find a diagonal filler $2 \times 1$, and hence for the overall $3 \times 1$ rectangle; but thanks to the retraction, this rectangle is exactly the original square.  [This proof probably shouldn't be in the main body; omit it entirely, or relegate it to an appendix?  But it is probably helpful for a non-homotopically experienced logician.]

Similarly, any transfinite composition of (term-, type-) contractible maps is again contractible.
\end{para}

\begin{example} \label{ex:elim-gives-contraction}
For any context morphism $f : \Delta \to \Theta$, the induced map of slices $f^*\colon \T \slice \Theta \to \T \slice \Delta$ is orthogonal to $i^\tm_0$ just if $f$ is orthogonal to all dependent projections---that is, if $f$ is a left map in the sense of Gambino--Garner \cite{gambino-garner}---or equivalently, if $f$ admits an ``elimination rule'':
$$\inferrule{\y : \Theta \types C(\y)\ \type \\ \z:\Delta \types d(\z): C(f(\z))}{\x : \Theta\ \types\ \mathsf{elim}_f(\y.C, \z.d; \x) : C(\x)}$$
(and associated computation rule).

$$\xymatrix{} $$

Moreover, $f^*$ is term-contractible exactly if every pullback of $f$ along a dependent projection is a Gambino--Garner left map, or equivalently if it supports the ``Frobenius'' form of this elimination rule, with extra dependent premises in the context, i.e.\ 
$$\y : \Theta, w: \Xi(\y) \types C(\y,\w)\ \type \ldots$$

This is implied by $f$ alone being a left map as long as $\T$ has identity types (by \cite[5.2.1]{gambino-garner}), or $\Pi$-types (by standard arguments).

In particular, for every reflexivity map $\r \colon \Delta.B \to \Delta.B.B.\Id_B$, the map $r^*$ between slices is term-contractible.  TODO: and for the variant $\Id$-elim.
\end{example}

\begin{example}
As remarked above, if $\T$ is any theory and $\T^\mathrm{LF}$ is its presentation in a logical framework, then according to \cite[\SEC 4]{hofmann:syntax-and-semantics}, the interpretation of $\T$ in $\T^\mathrm{LF}$ is type-contractible. 
\end{example}

\begin{para} Since $\DTT$ is the category of models of an algebraic theory, and so is locally presentable, we can use the machinery of \cite{garner:understanding} (the ``algebraic small-object argument'') to construct an algebraic weak factorisation system\footnote{aka natural weak factorisation system} on $\DTT$, using the universal extensions (term, type, or both) as the generating left maps.  The algebraic right maps in the resulting system are then just maps equipped with (term-, type-) contractions; the algebraic left maps are maps presented as (term, type, term-and-type) extensions.

We can think of the maps $i^\ty_n$, $i^\tm_n$ here as \emph{generating cofibrations} in a putative model structure on $\DTT$, and the contractible maps as the \emph{trivial fibrations}; this idea is taken a little further in Section \ref{sec:model-strux} below.

By example \ref{ex:elim-gives-contraction}, this factorisation system on $\DTT$ is in some sense dual to the Gambino--Garner systems on the classifying categories of individual theories.  We will make this idea more precise in Section \ref{sec:fam-strux-on-DTT}.
\end{para}






\subsection{Extensions by propositional copies: the conservativity principle $\Jbar$.}

On of the fundamental lemmas for many logical systems is that \emph{extension by definitions} should be well behaved: that if we extend a theory $\T$ by adding a new term $a'$, and an axiom that $a'$ is equal to some pre-existing term $a$ of $\T$, then the resulting theory is in some sense equivalent to $\T$.

For dependent type theories, this is clear when the new constructor is posited to be \emph{definitionally} equal to an existing one: the resulting theory $\T[a := a']$ is isomorphic to $\T$ itself.

However, one may also wish to understand a weaker situation, where the new term is only posited to be \emph{propositionally} equal to the existing one; precisely, where we extend $\T$ by axioms
$$\inferrule{\ }{\x : \Gamma \types a'(\x) : A(\x)} \qquad \inferrule{\ }{\Gamma \types l(\x) : \Id_A(a'(\x),a(\x)) }$$
Briefly, denote the resulting theory by $\T[a'(\x) :\propeq(\x) a]$, or when more detail is needed, by $\T[\x: \Gamma\ \types\ a'(\x) :\propeq_{l(\x)} a(\x) : A(\x)]$ or similar.

Categorically, extensions of this form are precisely pushouts of the universal ones 
$$\T_\stuff[\Gamma_{(n)} \types a: A] \mono \T_\stuff[\Gamma_{(n)} \types a: A][a'(\x) :\propeq a(\x)].$$
We will call (possibly transfinite) compositions of such pushouts \emph{extensions by propositional copies}, and write them as $\T[a_i'(\x) :\propeq a_i](\x)$

What can we now say about the inclusion $\T \mono \T[a'(\x) :\propeq a(\x)]$?  It is certainly not an isomorphism in general, nor indeed contractible, since $a'$ will rarely be in its image.  On the other hand, it is by definition a term-extension.  It is also certainly a monomorphism, since it has a retraction $\T[a'(\x) :\propeq a(\x)] \epi \T$, given by interpreting $a'$ as $a$ and $l$ as $r(a)$.

Our principle $\Jbar$ describes one sense in which $\T[a'(\x) :\propeq a(\x)]$ may reasonably be equivalent to $\T$:

\begin{definition}Say that \emph{$\Jbar$ holds for $\stuff$} if for every extension by propositional copies, the retraction $\T[a'(\x) :\propeq a(\x)] \epi \T$ is term-contractible.

In other words, the retractions of the universal such extensions
$$\T_\stuff[\Gamma_{(n)} \types a: A] \mono \T_\stuff[\Gamma_{(n)} \types a: A][a'(\x) :\propeq a(\x)].$$
right\end{definition}

(Actually, this is stronger than we will need: for present purposes, e.g.\ ``$\L_{\tm\ty}$-absolutely'' would be quite enough, i.e.\ that $\Jbar$ holds for extensions of cofibrant theories.)

If we consider adjoining only copies of \emph{closed} terms, i.e.\ in the case where $\Gamma = \diamond$, then note that the extension and its retraction are isomorphic to the maps of slices
$$\xymatrix{ \T \ar@{ >->}@/^/[r] \ar@{=}[d] & \T[a' :\propeq a] \ar@{->>}@/^/[l] \ar@{<=>}[d]|\iso \\
\T \slice \diamond \ar@{ >->}@/^/[r] & \T \slice (x:A, u:\Id(x,a)) \ar@{->>}@/^/[l] }
$$
induced by the retraction of contexts [TODO: yowch, fix horrible diagrams!]
$$\xymatrix{ \diamond \ar@{ >->}@/_/[r]_{a,r(a)} & (x:A, u:\Id(x,a)) \ar@{->>}@/_/[l]^{!}}.$$

But the map $(a,r(a)) \colon \diamond \mono x:A, i:\Id(x,a)$ is essentially an introduction map, so by Example \ref{ex:elim-gives-contraction}, the retraction  of slices $(a,r(a))^*$ is certainly term-contractible.

Thus $\Jbar$---like various other type-theoretic principles [TODO: which!?  I'm sure I had some good analogues in some point, but can't remember 'em now!]--- asserts that something which is holds easily for \emph{closed} terms holds also for \emph{open} terms.

One way to prove $\Jbar$ is therefore to reduce the general case to the closed case., via $\Pi$-types.  This is possible, as long as we assume $\Pi$-types, together with rules to make sure that their identity types are well-behaved:

\begin{proposition} \label{prop:jbar-holds-1}
$\Jbar$ holds for $(\Id,\Pi,\ext)$ (where $\ext$ includes the strong computation rules of \ref{para:ext-rules}) and any set of constructors extending this.
\end{proposition}

\begin{proof}
The diagram
$$\xymatrix{\T[k(\x):K(\x)] \ar[d] \ar@/_/[r] & \ar@/_/[l] \T[\hat{k}:\Pi_{\x} K(\x) \ar[d] \\ 
\T[k_0(\x),k_1(\x):K(\x),\ l(\x):\Id(k_0(\x),k_1(\x))] \ar@/_/[r] & \ar@/_/[l] \T[\hat{k}_0,\hat{k}_1 : \Pi_{\x} K(\x),\ \hat{l}:\Id(\hat{k}_0,\hat{k}_1)]}$$
exhibits its left-hand side (the map we wish to show contractible) as a retract of its right-hand side.  (The fact that the squares commutes and are a retraction requires the computation rules for $\ext$.)  But the right-hand side is just the closed case of $\Jbar$, which we've seen is contractible.
\end{proof}

In fact, we may strengthen this a little:
\begin{proposition} \label{prop:jbar-holds-2}
$\Jbar$ holds for $(\Id,\Pi,\PiIdelim)$, and any set of constructors extending this.
\end{proposition}

\begin{proof}
With the rules $\PiIdelim$ and $\Jbar$ stated as above \todo{[currently below!]}, we can define the eliminator $\Jbar$ in terms of $L$ by:
$$\Jbar(\underline{C},\underline{d},\underline{k},\underline{k}',\underline{l})\ :=\  L(\, [k,k',l]\,\underline{C}([x]k \tightcdot x,\,[x] k' \tightcdot x,\,[x] l \tightcdot x) ,\ d,\ \lambda \underline{k},\ \lambda \underline{k}',\ \lambda \underline{l} ).$$

It is routine to verify that under the hypotheses of the $\Jbar$ rule, this typechecks, and satisfies the required computational behaviour.
\end{proof}

However, $\Jbar$ may certainly fail as we weaken our system:

\begin{proposition} \label{prop:jbar-implies-ext}
For any set of constructors $\stuff$ including $\Pi$-types, $\Jbar$ implies a weak form of functional extensionality: if $x:A \types k(x),k'(x) : B$ and $x : A \types l(x):\Id(k(x),k'(x))$, then there is some term $\hat{l}$ for which $\types \hat{l} : \Id ( \lambda x.\,k(x),\, \lambda x.\, k'(x))$.
\end{proposition}

\begin{proof}
$\Jbar$ tells us that the map $\T_\stuff[k(x),k'(x),l(x)] \epi \T_\stuff[k(x)]$ is term-contractible; applying this to the type $\Id ( \lambda x.\,k(x),\, \lambda x.\, k'(x))$ upstairs and the term $r(\lambda x.\, k(x))$ downstairs yields a term as desired.
\end{proof}

\begin{corollary} \label{prop:jbar-fails}
$\Jbar$ fails for $(\Id,\Pi,\eta)$ and $(\Id,\Pi)$. 
\end{corollary}

\begin{proof}
The well-known  \todo{[Citation?]}  failures of $\ext$ in these systems are also failures of the conclusion of Proposition \ref{prop:jbar-implies-ext}.
\end{proof}

However, these failures involve essential use of $\Pi$-types.

\begin{conjecture}
$\Jbar$ holds for $(\Id)$.
\end{conjecture}

Proposition \ref{prop:jbar-fails} shows that if the conjecture is true, then $\Jbar$ is not stable under extensions of the constructor sets, so can't hold for $(\Id)$ as robustly as it does for $(\Id,\Pi,\ext)$: it may be \emph{admissible} for the type theory with just $\Id$-types, but it cannot be \emph{derivable}.

Maybe mention the analogous ``$\overline{K}$'' principle, and how it fails when UIP does?

\begin{para} A close relative of $\Jbar$ is Garner's eliminator $L$, proposed in \cite[5.7]{garner:on-the-strength}.  This is a strong form of functional extensionality; it is an eliminator for the type $u,v : \Pi_{x:A}B(x) \types \Pi_{x:A} \Id_{B(x)}(ux, vx)$, asserting essentially that this type is inductively generated by canonical elements of the form $\lambda x \tightcolon A.\ r(f(x))$, for \emph{open} terms $x:A \types f(x) : B(x)$.  Since it mentions open terms, it is most naturally given in a second-order formulation, using a logical framework as metalanguage:
$$ \inferrule*[right={$\PiIdelim$}]{
\Gamma,\ u, v : \Pi_{x:A}B(x), w : \Pi_{x:A} \Id_{B(x)}(u \cdot x,v \cdot x)\ \types\ C(u,v,w)\ \type \\ 
\Gamma,\ f : (x \tightcolon A) B(x)\ \types\ d(f) : C (\lambda f, \lambda f, \lambda (r \circ f)) \\
\Gamma\ \types\ k, k' : \Pi_{x:A} B(x) \qquad \Gamma\ \types\ l : (x \tightcolon A) \Id_{B(x)}(k x, k' x) }
{ \Gamma\ \types\ L(d,k,k',l) : C(k,k',l) } $$
Its computation rule concludes from appropriate premises that
$$ L(d, \lambda h, \lambda h, \lambda ( r \circ h)) = d(h) : C( \lambda h, \lambda h, \lambda (r \circ h)).$$

Here $(x \tightcolon A)B(x)$ denotes abstraction in the metalanguage; $u \cdot x$ denotes application in the object language.

In this second-order style, a version of $\Jbar$ may be stated as:
$$ \inferrule*[right={$\Jbar$}]{
\Gamma,\ k, k' : (x \tightcolon A) B(x),\ l : (x \tightcolon A) \Id_{B(x)}(kx,k'x)\ \types\ C(k,k',l)\ \type \\ 
\Gamma,\ f : (x \tightcolon A) B(x)\ \types\ d(f) : C ( f, f, r \circ f) \\
\Gamma\ \types\ k, k' : (x \tightcolon A) B(x) \qquad \Gamma\ \types\ l : (x \tightcolon A) \Id_{B(x)}(k x,k' x) }
{ \Gamma \types \Jbar(d,k,k',l) : C(k,k',l) } $$
and the corresponding computation rule concludes that
$$ \Jbar(d,k,k,r \circ k) = d(k) : C(k,k',l) . $$

(This is not exactly equivalent to the form of $\Jbar$ above, since this rule implies stability in the ambient context $\Gamma$.) 

Compare the two rules a bit!  Discuss!

(Notation!  Either explain Richard's notation, or change it to be more transparent.  Also, in choice of variable names: match Richard's paper for ease of comparison with that, or match what I'm using for $\Jbar$ the rest of the time?  Probably the latter: think about it.)
\end{para}

\begin{para} Waffle a bit more about how to look at $\Jbar$, why even \footnote{(non-homotopically-inclined)}type theorists should care, etc\ldots
\end{para}

























\section{Contractible operads; weak $\omega$-categories from $\DTT$} \label{sec:contractibility}

\todo{Include:  General contractibility of operads.  Give in terms of pylon diagrams.  Prune/contract pasting diagrams.  Recall L09/GvdB ``if whole glob obj is nice, then co-points of pds are ctrble''.  Refine that!  Reduce to more 1-d filling problem.}

\todo{In light of this, give various conditions for classifying weak $\omega$-category to exist: $\Jbar$ plus normalisation plus $(-)^\cxt$, etc.}

 In this section, we investigate various conditions under which we can map some contractible operad into $\End(\globes)$, and hence give a weak $\omega$-category structure.  In summary, we obtain a weak $\omega$-structure:
\begin{enumerate}
\item on $\cl_\omega$, conjecturally (depending on $\Jbar$), for all theories with $\Id$-types;
\item on $\cl_\omega$, unconditionally, for theories with $\Id$- and $\Pi$-types and Garner's rule $\PiIdelim$; and
\item on $\clpi_\omega$, for theories with $\Id$- and $\Pi$-types.  \todo{[See question above: we may need $\eta$ as well.]}
\end{enumerate}

\begin{figure}[htbp]
\caption{Contractibility in an endomorphism operad \label{fig:contractibility-pylons}} 
$$\bfig
%%%%%%%%%%%%%%%%%%%
% left hand pylon %
%%%%%%%%%%%%%%%%%%%
\node gn(250,0)[\globefig{n}]
\node gn1l(0,-250)[\globefig{n-1}]
\node gn1r(500,-400)[\globefig{n-1}]
\node gn2l(0,-650)[\globefig{n-2}]
\node fakegn2l(450,-650)[]
\node gn2r(500,-800)[\globefig{n-2}]
\node g1l(0,-1150)[\globefig{1}]
\node g1r(500,-1300)[\globefig{1}]
\node g0l(0,-1550)[\globefig{0}]
\node g0r(500,-1700)[\globefig{0}]
\arrow[gn1l`gn;]
\arrow[gn1r`gn;]
\arrow[gn2l`gn1l;]
\arrow[gn2r`gn1l;]
\arrow[gn2l`gn1r;]
\arrow[gn2r`gn1r;]
\arrow/@{}|<>(0.58)\vdots/[g1l`gn2l;]
\arrow/@{}|<>(0.58)\vdots/[g1r`gn2r;]
\arrow[g0l`g1l;]
\arrow[g0r`g1l;]
\arrow[g0l`g1r;]
\arrow[g0r`g1r;]
%%%%%%%%%%%%%%%%%%%%
% right hand pylon %
%%%%%%%%%%%%%%%%%%%%
\node Tpi(1750,0)[{\T_\Phi[\widehat{\pi}]}]
\node Tspi(1500,-250)[{\T_\Phi[\widehat{s\pi}]}]
\node Ttpi(2000,-400)[{\T_\Phi[\widehat{t\pi}]}]
\node Ts2pi(1500,-650)[{\T_\Phi[\widehat{s^2\pi}]}]
\node Tt2pi(2000,-800)[{\T_\Phi[\widehat{t^2\pi}]}]
\node Ts1pi(1500,-1150)[{\T_\Phi[\widehat{s_1\pi}]}]
\node Tt1pi(2000,-1300)[{\T_\Phi[\widehat{t_1\pi}]}]
\node Ts0pi(1500,-1550)[{\T_\Phi[\widehat{s_0\pi}]}]
\node Tt0pi(2000,-1700)[{\T_\Phi[\widehat{t_0\pi}]}]
\arrow[Tspi`Tpi;]
\arrow[Ttpi`Tpi;]
\arrow/@{>}|!{(500,-400);(2000,-400)}\hole/[Ts2pi`Tspi;]
\arrow/@{>}|!{(500,-400);(2000,-400)}\hole/[Tt2pi`Tspi;]
\arrow[Ts2pi`Ttpi;]
\arrow[Tt2pi`Ttpi;]
\arrow/@{}|<>(0.58)\vdots/[Ts1pi`Ts2pi;]
\arrow/@{}|<>(0.58)\vdots/[Tt1pi`Tt2pi;]
\arrow/@{>}|!{(500,-1300);(2000,-1300)}\hole/[Ts0pi`Ts1pi;]
\arrow/@{>}|!{(500,-1300);(2000,-1300)}\hole/[Tt0pi`Ts1pi;]
\arrow[Ts0pi`Tt1pi;]
\arrow[Tt0pi`Tt1pi;]
%%%%%%%%%%%%%%%%%%%%
% connecting wires %
%%%%%%%%%%%%%%%%%%%%
\arrow/@{.}/[gn`Tpi;H]
\arrow/@{>}|!{(250,0);(500,-400)}\hole/[gn1l`Tspi;F_{n-1}]
\arrow[gn1r`Ttpi;G_{n-1}]
\arrow/@{>}|<>(.19)\hole|!{(500,-800);(500,-400)}\hole/[gn2l`Ts2pi;F_{n-2}]
\arrow[gn2r`Tt2pi;G_{n-2}]
\arrow[g1l`Ts1pi;F_1]
\arrow[g1r`Tt1pi;G_1]
\arrow/@{>}|<>(.21)\hole|!{(500,-1700);(500,-1300)}\hole/[g0l`Ts0pi;F_0]
\arrow[g0r`Tt0pi;G_0]
\efig$$
\end{figure}

\subsection{Theories with $\Id$-types}

\renewcommand{\stuff}{\Id}
\begin{theorem}If $\Jbar$ holds for $\Id$, then $\End(\globes^\Id)$ is contractible.
\end{theorem}

\begin{proof}
As seen in section \ref{sec:endo-operads}, contractibility for this operad demands that given any pasting diagram $\pi \in T1(n)$, and $(F_0,G_0,\ldots G_{n-1})$ as in Fig.\ \ref{fig:contractibility-pylons}, we must construct $H$ to complete the map of spans; more concisely, we must complete the triangle
$$\xymatrix{ \del \globe[n] \ar[r]^{[F_i,G_i]} \ar@{ >->}[d] & \T_\stuff[\del \hat{\pi}]  \ar@{ >->}[r] & \T_\stuff[\hat{\pi}] \\ \globe[n] \ar@{.>}[urr] & }.$$

The cases $n= 0,1$ are dealt with by the discussion of \ref{para:map-from-cat} above.

On the other hand, when $n > 0$, it is immediate from the axiomatisations given that the map $\del \globe[n] \to/ >->/ \globe[n]$ is a term-extension.  Also, according to the pruning procedure described \ref{para:pruning} above, we can obtain $\T_\stuff[\hat{\pi}]$ as an extension of $\T_\stuff[\widehat{s_1\pi}]$ by propositional copies; so \emph{provided $\Jbar$ holds for $\DTT_\stuff$}, the retraction
$$\T_\stuff[\hat{\pi}] \epi \T_\stuff[\widehat{s_1\pi}]$$
(interpreting all identity cells as reflexivity terms) is term-contractible.

Thus to complete the triangle above, it is sufficient to complete the square
$$\xymatrix{ \del \globe[n] \ar[r]^{[F_i,G_i]} \ar@{ >->}[d] & \T_\stuff[\hat{\pi}] \ar@{->>}[d] \\ \globe[n] \ar@{.>}[r] & \T_\stuff[\widehat{s_1\pi}]},$$
i.e.\ to complete a triangle of the form
$$\xymatrix{ \del \globe[n] \ar[dr] \ar@{ >->}[d] & \\ \globe[n] \ar@{.>}[r] & \T_\stuff[\widehat{s_1\pi}]}.$$

But now $s_1\pi$ is just some $\path_l$, so as in \ref{para:map-from-cat}, \ref{para:canonicity-of-Tpath} we have an explicit axiomatisation of $\T_\Id(\widehat{s_1 \pi})$, and we know that this theory enjoys canonicity.  So in trying to extend $[F_i,G_i]$ along $ \del \globe[n] \mono \globe[n]$, we have interpreted $i$-$\sourcerule$ and $i$-$\targetrule$ in $\T_\stuff[\widehat{s_1\pi}]$, for $i < n$, and wish to interpret $n$-$\cellrule$; i.e.\ we wish to prove a propositional equality between the interpretations of $s_{n-1}(x)$ and $t_{n-1}(x)$.   But by canonicity, and the simplicity of our set of constructors, any two terms of the same type in $\T_\stuff[\widehat{s_1\pi}]$ are \emph{definitionally} equal; so interpreting $c_n$ as a reflexivity term, we are done.  (Specifically, $s_1$, $t_1$ must both be interpreted as the obvious composite of basic constructors described in \ref{para:map-from-cat}, and for $i > 1$, $s_i$ and $t_i$ must be interpreted as the reflexivity term over $s_{i-1}$, $t_{i-1}$.)
\end{proof}

\subsection{$\End(\globes)$, in theories with $\PiIdelim$}

\renewcommand{\stuff}{\PiIdelim}
\begin{para} By turning our attention to theories with not only $\Id$-types but also $\Pi$-types and the $\PiIdelim$ rule, we ensure that $\Jbar$ holds unconditionally.  However, this comes at the possible cost of normalisation and canonicity.  \todo{[Is ``possible'' necessary here?]}  Thus, in trying to repeat the argument above to show that $\End(\globes)$ is contractible, we fall at the last hurdle: we do not know that $[F_i,G_i]$ gives the ``correct'' map $\del \globe[n] \to \T_\stuff[\widehat{\path_l}]$.

To remedy this, we simply restrict to the sub-operad of operations for which this holds.  This is essentially just a slightly more complicated analogue of the tactic used in \cite{garner-van-den-berg}, of restricting to the operad of point-preserving operatons, as discussed in Section \ref{sec:lumsdaine-versus-gvdb}. 
\end{para}


\begin{definition} For $\E$ any category with pullbacks, define a monoidal category $\RefnGlob{1}{\E}$ as follows:
\end{definition}

\begin{wrapfigure}[15]{r}{0.15\textwidth}
\vskip -1.5em
$\bfig
\node An(0,0)[A_n]
\node An1(0,-400)[A_{n-1}]
\node A2(0,-900)[A_2]
\node A1(0,-1300)[A_1]
\node A0(0,-1700)[A_0]
\arrow|m|/@<0ex>/[An`An1;s]
\arrow|m|/@<1ex>/[An`An1;t]
\arrow/@{}|<>(0.58)\vdots/[A2`An1;]
\arrow|m|/@<0ex>/[A2`A1;s]
\arrow|m|/@<1ex>/[A2`A1;t]
\arrow|m|/@<-0.5ex>/[A1`A0;s]
\arrow|m|/@<0.5ex>/[A1`A0;t]
\arrow|m|/@/^0.5em//[A1`A2;r]
\arrow|m|/@/^1.35em//[A1`An1;r]
\arrow|m|/@/^2.5em//[A1`An;r]
\efig$\caption{\label{fig:modspan} \textcolor{white}{longword}}
\end{wrapfigure}

Objects in dimension $n$ are globular objects $\A$ of $\E$, together with \emph{reflexivity data from dimension 1}: for $1 \leq i \leq n$, a map $r_i \colon A_1 \to A_i$, such that $s_i r_{i+1} = t_i r_{i+1} = r_i$, and $r_1 = 0$.\footnote{Is there pre-existing terminology for this?}

A map between two of these is a map $(f_i,g_i,h)$ between their ``underlying'' spans, with $f_0 = g_0$, $f_1 = g_1$, and commuting with the reflexivity data in that $f_i r_i = g_i r_i = r_i f_1$, and $h r_n = r_n f_1$.

The monoidal globular structure of $\RefnGlob{1}{\E}$ is lifted from that of $\Spans[\E]$.  Any tensor product $\A \tensor_k \B$ in $\Spans[\E]$ of globular objects is again globular, and reflexivity data on the multiplicands lifts naturally to reflexivity data on the product; and similarly, the units over globular objects are globular and carry natural reflexivity data. \\

We thus have a monoidal globular category and faithful forgetful functor
$$\RefnGlob{1}{\E} \to \Spans[\E].$$

(Note that, as the definition of the maps hints, the globularity condition on objects in dimensions $>1$ is not actually required here, and it would arguably be more natural to omit it.  However, all spans occurring in the construction of endomorphism operads remain fully globular, so it makes no difference for present purposes, and it simplifies the specification of the reflexivity data.) \\

Instantiating this construction with $\E = \DTT^\op$, the globes $\globes$ lift (using their reflexivity maps) to a globular object in $\RefnGlob{1}{\DTT^\op}$.  We this obtain a new endomorphism operad for them---a sub-operad of the old, since the functor inducing the map is faithful:
$$\End_{\RefnGlob{1}{\DTT^\op}}(\globes) \mono \End(\globes)$$

\begin{para}From here we need to restrict still a little further before we have a contractible operad: we need to look at just those operations which do the correct thing in dimensions $\leq 1$.  Specifically, the map $\psi \colon P_\Cat \to \tr^1\End(\globes)$ is easily seen to factor through $\End_{\RefnGlob{1}{\DTT^\op}}(\globes)$; so let $Q_{\globes}$ be the pullback
% $$\xymatrix{ P \ar[r] \ar[d] & \End_{ModSpans[\DTT^\op]}(\globes) \ar[d]^\eta \\ P_{\strwCat} = I P_\Cat \ar[r]^{I \psi} & I \tr^1 \End_{ModSpans[\DTT^\op]}(\globes)}$$
$$\bfig 
\node Q(0,400)[Q_{\globes}]
\node End(1400,400)[\End_{\RefnGlob{1}{\DTT^\op}}(\globes)]
\node Pstr(0,0)[P_{\strwCat} = I P_\Cat]
\node ItrEnd(1400,0)[I \tr^1 \End_{\RefnGlob{1}{\DTT^\op}}(\globes)]
\arrow/@{ >->}/[Q`End;]
\arrow[Q`Pstr;]
\arrow[End`ItrEnd;\eta]
\arrow/@{ >->}/[Pstr`ItrEnd;I \psi]
\place(100,300)[\pb]
\efig$$
where $I \colon \nOpd[1] \to \nOpd[\omega]$ is the ``indiscrete'' functor, right adjoint to $\tr^1$; then $Q_{\globes}$ consists precisely of those operations of $\End_{\RefnGlob{1}{\DTT^\op}}(\globes)$ whose $\leq 1$-dimensional parts lie in the image of $\psi$.  We are now set up for:
\end{para}

\begin{proposition}The suboperad $Q_{\globes} \mono \End(\globes)$ is contractible.
\end{proposition}

\begin{proof}Contractibility in dimensions $\leq 1$ holds by fiat: in these dimensions, $Q_{\globes}$ is isomorphic to the terminal operad.

For higher dimensions, note that operations in this new operad are just as in the old, except that additionally the maps involved must commute with the reflexivity data.  So contractibility now demands that for $\pi \in \pd_n$, and suitable $(F_i,G_i)_{i < n}$, we must produce a map $H : \globes[n] \to \T_\stuff[\widehat{\pi}]$ making both squares in the following commute:
$$\xymatrix{ 
  \del \globe[n] \ar[r]^{[F_i,G_i]} \ar@{ >->}[d] 
  & \T_\stuff[\del \hat{\pi}]  \ar@{ >->}[d] 
\\
  \globe[n] \ar@{.>}[r]  \ar@{->>}[d]
  & \T_\stuff[\hat{\pi}] \ar@{->>}[d]
\\ 
  \globe[1] \ar[r]_{F_1 = G_1}
  & \T_\stuff[\widehat{s_1 \pi}]
}.$$

But the overall rectangle commutes, so the desired filler follows by $\Jbar$.
\end{proof}




\subsection{$\End(\piglobes)$}

Give this version.

\subsection{Classifying weak $\omega$-categories}
% TODO: should be \\\texorpdfstring here

\begin{para} In each of the above cases, the resulting map $L \to \End(\globes)$ allows us to pull the $\End(\globes)$-action on $\cl_\omega$ back to an action of $L$.  We thus have a functor into $\wkwCat$, which in flagrant abuse of notation we continue to denote $\cl_\omega$:
$$\bfig
\node DTT(0,0)[\DTT_\Phi]
\node EndGAlg(1000,500)[\Alg{\End(\globes)}]
\node GSets(1400,0)[\GSets]
\node wkwCat(1800,500)[\wkwCat]
\arrow[DTT`GSets;\cl_{\omega}]
\arrow[DTT`EndGAlg;\cl_{\omega}]
\arrow[EndGAlg`wkwCat;]
\arrow[EndGAlg`GSets;]
\arrow[wkwCat`GSets;]
\efig$$
\end{para}

We thus have:

\begin{theorem}If $\stuff$ is any set of rules for which $\Jbar$ and Corollary \ref{cor:normalisation} hold, then for any $\stuff$-theory $\T$, the globular set $\cl_\omega(\T)$ described in the introduction has a natural weak $\omega$-category structure; that is, we have a functor
$$\cl_\omega \colon \DTT \to \wkwCat.$$

In particular, this construction works when $\stuff$ is the rules for $\Id$-types, $\Pi$-types, and functional extensionality.
\end{theorem}

\subsection{A variant for non-extensional $\Pi$-types}

As noted above, $\Jbar$ (and hence this proof) fail in the category of theories with non-extensional $\Pi$-types.  Altering the globes a little lets us make things work there, so givs a little more generality for the classifying weak $\omega$-category.  On the other hand, this generality would come \emph{better} via our conjecture of $\Jbar$ for $(\Id)$\ldots

\subsection{CwF structures on $\CwF_\diamond^\op$ etc.}

An alternate perspective on $\Jbar$, shows that it can be seen not just as analogous to the $\Id$-elim rule, but actually as instance of it for a certain families-structure:

There are various important CwF-structures on categories of CwF's. In particular: there is a canonical CwF structure on $\CwF_\diamond^\op$, given by $\Ty^\mathrm{canon}_{\CwF_\diamond^\op}(\C) := \Ty_\C(\diamond)$, and $\C.A := \C/\!/A$.  The universal properties of slices (Proposition \ref{prop:slicing}), with general facts about free constructions, ensure that the requisite squares [diagram] are pullbacks.  (This is in some sense a universal CwF: certainly every small CwF may be obtained by pullback from it, a more precise statement can probably be formulated.)

This extends to a canonical CwF-structure with $\Id$-types on $(\CwF^\Id_\diamond)^\op$, a CwF-structure with $\Id$- and $\Pi$-types with $\eta$-rule on $(\CwF^{\Id,\Pi,\eta}_\diamond)^\op$, and so on.

However, we can bump up these structures a little further, to include certain ``formal $\Pi$-types'' (independently of what $\Pi$-types may already be present in the theories).  That is, we define $\Ty^\mathrm{canon + Pi}(\C) := \sum_{\Gamma \in \C} \Ty_\C(\Gamma)$; so a type over $\C$, in this families structure, is a type $A$ in some context $\Gamma$ of $\C$, to be thought of as the formal dependent product $\prod_\Gamma A$.

Context extension is by adjoining \emph{open} terms.

$\Jbar$ asserts that \emph{open} $\Id$-types in contexts are indeed $\Id$-types in this families structure.  (But danger, Will Robinson, danger: $\Jbar$ doesn't assert, and afaics doesn't imply, the stability/coherence conditions required for ``this families structure has $\Id$-types''.)


\clearpage










































%% Bibliography Info

\bibliographystyle{amsalpha}
\bibliography{pll-thesis-bib}



\end{document}